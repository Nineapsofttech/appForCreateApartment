angular.module("world.salescontrollers",["ngCookies","ngTouch","ngAnimate","ngSanitize"]).controller("MainController",["$scope","$rootScope",function(){}]).controller("Login",["$scope","$cookies","$rootScope","$location","$route","$window","Check","User",function(e,a,o,t,n,i,l,r){if(o.permissionGlobal=-1,o.loading=!1,o.checkPermission=function(){""!==a.Email&&""===a.Tel?r.query({email:a.Email},function(e){console.log("2034 controller.js"),console.log(e),e.email&&(a.Name=e.name,a.Email=e.email,a.Permission=e.permission,a.Hash=e.password,a.UID=e._id,a.Favoriteap=e.favoriteap,a.Balance=e.balance),void 0!==a.Name?(o.username=a.Name,o.permissionGlobal=a.Permission,t.replace()):(o.user_logout=!0,"/homes"===t.path()||"/info"===t.path()||"/result"===t.path())}):""!==a.Tel&&""===a.Email?r.query({tel:a.Tel},function(e){console.log("2074 controller.js"),console.log(e),e.email&&(a.Name=e.name,a.Email=e.email,a.Permission=e.permission,a.Hash=e.password,a.UID=e._id,a.Favoriteap=e.favoriteap,a.Balance=e.balance),void 0!==a.Name?(o.username=a.Name,o.permissionGlobal=a.Permission,t.replace()):(o.user_logout=!0,"/homes"===t.path()||"/info"===t.path()||"/result"===t.path())}):""!==a.Tel&&""!==a.Email?r.query({tel:a.Tel},function(e){console.log("2114 controller.js"),console.log(e),e.email&&(a.Name=e.name,a.Email=e.email,a.Permission=e.permission,a.Hash=e.password,a.UID=e._id,a.Favoriteap=e.favoriteap,a.Balance=e.balance),void 0!==a.Name?(o.username=a.Name,o.permissionGlobal=a.Permission,t.replace()):(o.user_logout=!0,"/homes"===t.path()||"/info"===t.path()||"/result"===t.path())}):(delete a.UID,delete a.Hash,delete a.Name,delete a.Permission,delete a.Email,delete a.Favoriteap,delete a.Choosemenu,delete a.Balance,o.permissionGlobal=-1,t.path("/homes"),t.replace())},a&&"undefined"!=typeof a)try{var s=a.Email;void 0!==s&&"undefined"!=typeof s&&(o.user_email=a.Email),0==a.Permission?o.user_stat="Standard User":1==a.Permissio?o.user_stat="Administrator":2==a.Permission&&(o.user_stat="VIP User"),o.user_name=a.Name!==a.Email?a.Name:"ยังไม่ได้ทำการตั้งชื่อ"}catch(c){}e.$on("$routeChangeSuccess",function(){void 0===a.Permission?"/controlpanel"===t.path():"/controlpanel"===t.path()}),o.checkPermission(),o.distance=function(e,a,o,t,n){var i=Math.PI*e/180,l=Math.PI*o/180,r=(Math.PI*a/180,Math.PI*t/180,a-t),s=Math.PI*r/180,c=Math.sin(i)*Math.sin(l)+Math.cos(i)*Math.cos(l)*Math.cos(s);return c=Math.acos(c),c=180*c/Math.PI,c=60*c*1.1515,"M"==n&&(c=1.609344*c),"N"==n&&(c=.8684*c),c},e.logoutsend=function(){delete a.UID,delete a.Hash,delete a.Name,delete a.Permission,delete a.Email,delete a.Favoriteap,delete a.Choosemenu,delete a.Balance,delete a.Tel,o.permissionGlobal=-1,t.path("/homes"),t.replace()},e.loginsend=function(){l.query({username:e.login.username,password:e.login.password},function(n){void 0!==n.permission?(a.Tel=n.tel,a.Name=n.name,a.UID=n._id,a.Hash=n.password,a.Permission=n.permission,a.Email=n.email,a.Favoriteap=n.favoriteap,o.permissionGlobal=a.Permission,o.username=a.Name,e.displayCheckBox=!1,t.path("/homes"),t.replace()):alert("Please Check your username and password")})}}]).controller("memberCtrl",["$scope","$rootScope","$window","$cookies","$route","$location","Uploadprofilepic","Filtermain","Member","CreateProperty","Paypal","Favoritboard","PasswordChange","User","Info","Duplicate",function(e,a,o,t,n,i,l,r,s,c,p,d,m,u,g,f){a.heading,a.pitch,e.error_alert=function(e,o){a.closed=!1,document.getElementById("error_containner").className="modal__upload",document.getElementById("errtitle").innerHTML=e,document.getElementById("errmessage").innerHTML=o},a.close_error_modal=function(){document.getElementById("error_containner").className="modal__upload hidden__div"},e.resetpin=function(){navigator.geolocation?navigator.geolocation.getCurrentPosition(function(a){var o=new google.maps.LatLng(a.coords.latitude,a.coords.longitude);console.log(o),e.map.setCenter(o)}):alert("กรุณาเปิด GPS ด้วยนะ")};try{void 0!==t.Email||"/homes"===i.path()}catch(h){console.log(h),"/homes"===i.path()}e.duplicatestatus=!1,e.ctrl="index",e.noticficationCounter=0,e.show_aprt=!0;var _=0;e.up={},e.profile_edit=!0,e.profile_myprofile=!1,e.preview_on_upgrade=!1,e.cre_ads=!1,e.show_customers=!0,e.reset_pas={},e.user={},e.balance=t.Balance,e.disObj=[];var v=[],y="image/icon/map_pin.png";e.distances=[],5==a.permissionGlobal?r.query({permission:t.UID},function(a){e.list=a}):r.query({all:t.UID},function(a){e.list=a}),void 0===t.Tel&&void 0===t.Email||(""!==t.Tel&&""===t.Email?u.query({tel:t.Tel},function(a){null!==a&&(e.user=a)}):""===t.Tel&&""!==t.Email?u.query({email:t.Email},function(a){null!==a&&(e.user=a)}):u.query({tel:t.Tel},function(a){null!==a&&(e.user=a)}));var w=new FormData;e.$on("$routeChangeSuccess",function(){if("/controlpanel"===i.path())try{e.ctrl=t.Choosemenu}catch(a){e.ctrl="index",console.log(a)}}),e.edit_apartment_detail=function(o){g.query({_id:o},function(o){e.add_aprt="add",e.up=o,console.log(o),e.isDuplicate(),e.findzip(),delete t.lat,delete t.lng,e.up.district=o.district,a.location=o.location,a.heading=o.heading,a.pitch=o.pitch,e.up.amphur=o.amphur,e.up.province=o.province,e.setzipcodeform(e.up.district,e.up.amphur),e.up.electric_bill=parseInt(e.up.electric_bill),e.up.heading=parseInt(e.up.heading),e.up.no_building=parseInt(e.up.no_building),e.up.no_room=parseInt(e.up.no_room),e.up.heading=parseInt(e.up.heading),e.up.pitch=parseInt(e.up.pitch),e.up.price_min=parseInt(e.up.price_min),e.up.price_max=parseInt(e.up.price_max),e.up.utility=parseInt(e.up.utility),e.up.water_bill=parseInt(e.up.water_bill),e.add_apart_init()})},e.isDuplicate=function(){f.query({namespace:e.up.namespace},function(a){try{a.data&&a.data._id!==e.up._id.toString()?(e.register.namespace.$error.pattern=!0,e.duplicatestatus=!1):e.duplicatestatus=!0}catch(o){console.log(o)}})},e.removeproperty=function(a){confirm("Are you sure?")&&g.kill({_id:a},function(){r.query({all:t.UID},function(a){e.list=a})})},e.displaypreview=function(a){w=new FormData,console.log("----------------"),document.getElementById("displaypreviews").innerHTML="";for(var o,n=0;o=a.files[n];n++)if(o.type.match("image.*"))if(a.files[0].size/1e3<250)if(console.log(a.files[0].name.split(".").pop().toLowerCase()),"jpg"===a.files[0].name.split(".").pop().toLowerCase()||"jpeg"===a.files[0].name.split(".").pop().toLowerCase()||"png"===a.files[0].name.split(".").pop().toLowerCase()||"gif"===a.files[0].name.split(".").pop().toLowerCase()){w.append("profilepic",a.files[n]),w.append("user_id",t.UID);var i=new FileReader;i.onload=function(){return function(e){document.getElementById("displaypreviews").src=e.target.result;var a=new XMLHttpRequest;a.upload.onprogress=function(e){document.getElementById("process_bar_containner").className="modal__upload";var a=e.loaded/e.total*100;document.getElementById("process_bar").style.width=a+"%",console.log(a)},a.onload=function(){200==a.status?document.getElementById("process_bar_containner").className="modal__upload hidden__div":alert("Error! Upload failed")},a.onerror=function(){alert("Error! Upload failed. Can not connect to server.")},a.open("POST","/uploadprofilepic"),a.send(w)}}(o),i.readAsDataURL(o)}else e.error_alert("อัพโหลดผิดพลาด","นามสกุลไฟล์ไม่ถูกนะ : "+a.files[0].name);else e.error_alert("อัพโหลดผิดพลาด","ไฟล์ขนาดเกิน 250kb นะ ดูสิ  "+a.files[0].name+":"+a.files[0].size/1e3+"KB");else e.error_alert("อัพโหลดผิดพลาด","นามสกุลไฟล์ไม่ถูกนะ")},e.previewdraganddrop=function(e){document.getElementById("Previewzone").innerHTML="";for(var a,o=0;a=e.files[o];o++)if(a.type.match("image.*")){w.append("photogal",e.files[o]);var t=new FileReader;t.onload=function(){return function(e){var a=new Image(200,0);a.src=e.target.result,document.getElementById("Previewzone").appendChild(a)}}(a),t.readAsDataURL(a)}},e.add_apart_init=function(){var t=o.setInterval(function(){e.map||a.$broadcast("capstreetMap",!0),clearTimeout(t)},700)},e.initNMAP=function(){a.$broadcast("mapReady",!0)},e.initPMAP=function(){a.$broadcast("capstreetMap",!0)},e.$on("capstreetMap",function(){e.distances=[];navigator.geolocation?navigator.geolocation.getCurrentPosition(function(o){var n;a.location?n=new google.maps.LatLng(a.location[1],a.location[0]):void 0===t.lat?(n=new google.maps.LatLng(o.coords.latitude,o.coords.longitude),a.location=[],a.location[0]=o.coords.longitude,a.location[1]=o.coords.latitude):n=new google.maps.LatLng(t.lat,t.lng);var i;console.log(a.heading),console.log(a.pitch),i=void 0!==a.heading?{position:n,pov:{heading:parseInt(a.heading),pitch:parseInt(a.pitch)},scrollwheel:!1,zoom:1}:{position:n,pov:{heading:270,pitch:0},scrollwheel:!1,zoom:1},e.map=new google.maps.StreetViewPanorama(document.getElementById("map-canvas"),i),e.map.setVisible(!0),google.maps.event.addListener(e.map,"pov_changed",function(){e.up.heading=parseInt(e.map.getPov().heading),e.up.pitch=parseInt(e.map.getPov().pitch),a.heading=parseInt(e.map.getPov().heading),a.pitch=parseInt(e.map.getPov().pitch),console.log(e.up.heading+"      :      "+e.up.pitch)}),null==t.lat},function(){e.handleNoGeolocation(!0)}):e.handleNoGeolocation(!1)}),e.add_customers=function(){e.show_customers=!1};try{document.getElementById("overlay").style.visibility="hidden"}catch(h){}finally{e.profile_myprofile=!1,e.profile_upgrade=!0}e.send_mail=function(){e.reset_pas.email=t.Email,m.post({reset:e.reset_pas},function(e){console.log(e),alert(0==e[0]?"password ถูกเปลี่ยนเรียบร้อยแล้ว":"เกิดข้อผิดพลาดกรุณาลองใหม่ภายหลัง")})},e.add_aprt=function(){e.show_aprt=!1,a.$broadcast("mapReady",!0)},e.back_page_aprt=function(){e.show_aprt=!0,n.reload()},e.resend=function(){try{document.getElementById("overlay").style.visibility="visible"}catch(e){console.log(e)}finally{_++,a.loading=!0,1==_&&s.query({email:t.Email,hash:t.Hash},function(e){if(1==e[0])try{document.getElementById("overlay").style.visibility="hidden"}catch(o){}finally{a.loading=!1,_--,alert("กรุณายืนยันผู้ใช้ทาง Email \nหากยังไม่ได้รับ Email ยืนยัน \nกรุณาตรวจสอบในถังขยะ(junk mail)")}else try{document.getElementById("overlay").style.visibility="hidden"}catch(o){}finally{_--,alert("เกิดข้อผิดพลาด กรุณาติดต่อเจ้าหน้าที่")}})}},e.show_profile=function(){e.profile_myprofile=!1,e.profile_upgrade=!0,e.profile_edit=!0},e.show_upgrade=function(){e.initlist=new Array,a.$broadcast("mapReady",!0),0==t.Permission&&alert("กรุณายืนยันผู้ใช้ทาง Email ก่อนใช้งาน\nหากยังไม่ได้รับ Email ยืนยัน \nกรุณาตรวจสอบในถังขยะ(junk mail) \nหรือกด re active เพื่อนทำการส่ง Email ยืนยันใหม่")},e.show_edit_profile=function(){e.profile_edit=!1,e.profile_myprofile=!0},e.update=function(e,n){var i={},l=e;i.element={},i.element[l]=n,i._id=t.UID,s.post({text:i},function(e){1==e[0]&&"name"===l&&(delete t.Name,t.Name=n,a.user_name=t.Name,o.location.reload())})},e.back_page=function(){e.profile_edit=!0,e.profile_myprofile=!1,e.cre_ads=!1,n.reload()},e.logopreview=function(e){var a=e;try{for(var o,t=0;o=a.files[t];t++)if(o.type.match("image.*")){w.append("logo",e.files[t]);var n=new FileReader;n.onload=function(){return function(e){try{document.getElementById("adspv").style.backgroundImage="url('"+e.target.result+"')"}catch(e){}try{document.getElementById("logopreviewoncreateapartment").src=e.target.result,document.getElementById("logopreviewoncreateapartment2").src=e.target.result}catch(e){}}}(o),n.readAsDataURL(o)}else alert("นามสกุลไฟล์ไม่ถูกนะ : "+e.files[0].name)}catch(i){}},e.headerpreview=function(e){for(var a,o=e,t=0;a=o.files[t];t++)if(a.type.match("image.*")){w.append("header",e.files[t]);var n=new FileReader;n.onload=function(){return function(e){document.getElementById("headerpreviewoncreateapartment").style.backgroundImage="url('"+e.target.result+"')",document.getElementById("headerpreviewoncreateapartment2").src=e.target.result}}(a),n.readAsDataURL(a)}else alert("นามสกุลไฟล์ไม่ถูกนะ : "+e.files[0].name)},e.upgrade=function(){e.up.location=[a.location[0],a.location[1]],e.up.user_id=t.UID,console.log(e.up.heading+"    :    "+e.up.pitch),console.log(a.heading+"    :    "+a.pitch),c.post({property:e.up},function(o){if(e.statUp=o,void 0!==o._id&&w){try{w.append("user_id",t.UID),w.append("id",o._id);var n=new XMLHttpRequest;n.upload.onprogress=function(a){document.getElementById("process_bar_containner").className="modal__upload";var o=a.loaded/a.total*100;document.getElementById("process_bar").style.width=o+"%",100==o&&(document.getElementById("process_bar_containner").className="modal__upload hidden__div",e.add_aprt="show"),console.log(o)},n.onload=function(){200==n.status?document.getElementById("process_bar_containner").className="modal__upload hidden__div":(document.getElementById("process_bar_containner").className="modal__upload hidden__div",alert("Error! Upload failed"))},n.onerror=function(){alert("Error! Upload failed. Can not connect to server.")},n.open("POST","/uploadpic"),n.send(w)}catch(i){}finally{e.up={},a.setCC("manage")}r.query({all:t.UID},function(a){e.list=a})}else a.setCC("manage")})},o.initMap=function(){e.initlist=new Array},e.nearbysearch=function(){var o=[];e.disObj=[],angular.forEach(e.choose,function(e){0!=e&&o.push(e)});var t=new google.maps.LatLng(e.map.center.lat(),e.map.center.lng()),n={location:t,radius:1e3*e.chooses.radius,types:o};e.service=new google.maps.places.PlacesService(e.map),e.service.nearbySearch(n,function(t){e.nearbyPlaces=t,o=[];for(var n=e.nearbyPlaces.length-1;n>=0;n--)e.disObj.push(a.distance(e.nearbyPlaces[n].geometry.location.k,e.nearbyPlaces[n].geometry.location.B,e.map.center.lat(),e.map.center.lng(),""));e.$apply()})},e.condos=[],e.$on("mapReady",function(){try{var o={zoom:14,scrollwheel:!1,disableDoubleClickZoom:!0};e.map=new google.maps.Map(document.getElementById("map-canvas"),o),navigator.geolocation?navigator.geolocation.getCurrentPosition(function(o){var n;n=a.location?new google.maps.LatLng(a.location[1],a.location[0]):void 0===t.lat?new google.maps.LatLng(o.coords.latitude,o.coords.longitude):new google.maps.LatLng(t.lat,t.lng),e.marker=new google.maps.Marker({position:n,title:"Your Location",draggable:!0,icon:y}),google.maps.event.addListener(e.map,"center_changed",function(){var o=new google.maps.LatLng(e.map.center.lat(),e.map.center.lng());t.lat=e.map.center.lat(),t.lng=e.map.center.lng(),a.location=[],a.location[1]=e.map.center.lat(),a.location[0]=e.map.center.lng(),e.marker.setPosition(o)}),google.maps.event.addListener(e.marker,"dragend",function(o){for(var n=0;n<v.length;n++)v[n].setMap(null);t.lat=o.latLng.lat(),t.lng=o.latLng.lng(),a.location[1]=o.latLng.lat(),a.location[0]=o.latLng.lng();var i=new google.maps.LatLng(t.lat,t.lng);e.map.setCenter(i)}),e.marker.setMap(e.map),e.map.setCenter(n),null==t.lat},function(){e.handleNoGeolocation(!0)}):e.handleNoGeolocation(!1)}catch(n){}}),e.handleNoGeolocation=function(a){if(a)var o="Error: The Geolocation service failed. Please click on the map to change location.";else var o="Error: Your browser doesn't support geolocation. Please click on the map to change location.";{var t={map:e.map,position:new google.maps.LatLng(13.883661700000001,100.5698831),content:o};new google.maps.InfoWindow(t)}e.map.setCenter(t.position),e.showMeTheCondo(t.position)}}]);