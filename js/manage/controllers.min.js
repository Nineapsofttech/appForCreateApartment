"use strict";angular.module("manage.controllers",["ngCookies","datePicker","ngTouch","ngAnimate","googlechart","ngSanitize","ui.calendar"]).controller("ManageCtrl",["$scope","$rootScope","$routeParams","$log","$anchorScroll","$location","TransactionApi","ResetDemo",function(e,o,t,r,i,n,a,c){angular.element(document).ready(function(){o.checkpermission(),a.query({stat_type:1},function(e){r.log(e)}),e.resetdemo=function(){var e=confirm("คุณต้องการลบ ข้อมูล Demo ออกจากระบบ?");1==e&&c.post({confirm_reset:1},function(e){r.warn(e),o.checkpermission()})}})}]).controller("CashierInvoiceCtrl",["$scope","$rootScope","$routeParams","$log","$anchorScroll","$location","TransactionApi",function(e,o,t,r,i,n,a){angular.element(document).ready(function(){o.checkpermission(),e.customer_ref={},e.event=0,e.pay_status=0,e.save_payment=function(o){console.log(o),13==o.keyCode&&0==e.pay_status&&(e.pay_status=1,window.open("/manager#!/print_report_vat?transaction_id="+e.transaction._id,"_blank"))},void 0!==t.pay_id&&a.get({receipt:t.pay_id},function(o){o.$resolved&&(console.log(o),e.transaction=o,e.amount=o.room_ref.room_rate+o.room_ref.room_furniture+(o.water_meter[0].water_meter-o.water_meter[1].water_meter)*o.room_ref.room_water_extra,e.amount+=(o.elect_meter[0].elect_meter-o.elect_meter[1].elect_meter)*o.room_ref.room_energy_extra,e.customer_ref=o.customer_ref,e.room_no=o.room_ref.room_no)})})}]).controller("ReportAdminCtrl",["$scope","$rootScope","$routeParams","$log","$anchorScroll","$location","TransactionApi","ResetDemo",function(e,o,t,r,i,n,a,c){angular.element(document).ready(function(){o.checkpermission(),a.query({stat_type:1},function(e){r.log(e)}),e.resetdemo=function(){var e=confirm("คุณต้องการลบ ข้อมูล Demo ออกจากระบบ?");1==e&&c.post({confirm_reset:1},function(e){r.warn(e),o.checkpermission()})}});var l={};l.type="BarChart",l.cssStyle="height:200px; width:100%;",l.data={cols:[{id:"month",label:"เดือน",type:"string"},{id:"laptop-id",label:"ค่าน้ำ",type:"number"},{id:"desktop-id",label:"ค่าไฟ",type:"number"},{id:"server-id",label:"ค่าห้อง",type:"number"},{id:"cost-id",label:"เฟอร์นิเจอร์",type:"number"}],rows:[{c:[{v:"January"},{v:42,f:"42"},{v:12,f:"12"},{v:7,f:"7"},{v:4}]},{c:[{v:"February"},{v:13},{v:1,f:"1"},{v:12},{v:2}]},{c:[{v:"March"},{v:24},{v:0},{v:11},{v:6}]}]},l.options={title:"Sales per month",isStacked:"true",fill:20,displayExactValues:!0,vAxis:{title:"Sales unit",gridlines:{count:6}},hAxis:{title:"Date"}},l.formatters={},e.chart=l;var s={};s.type="Table",s.cssStyle="height:200px; width:100%;",s.data={cols:[{id:"month",label:"เดือน",type:"string"},{id:"laptop-id",label:"ค่าน้ำ",type:"number"},{id:"desktop-id",label:"ค่าไฟ",type:"number"},{id:"server-id",label:"ค่าห้อง",type:"number"},{id:"cost-id",label:"เฟอร์นิเจอร์",type:"number"}],rows:[{c:[{v:"January"},{v:42,f:"42"},{v:12,f:"12"},{v:7,f:"7"},{v:4}]},{c:[{v:"February"},{v:13},{v:1,f:"1"},{v:12},{v:2}]},{c:[{v:"March"},{v:24},{v:0},{v:11},{v:6}]}]},s.options={title:"Sales per month",isStacked:"true",fill:20,displayExactValues:!0,vAxis:{title:"Sales unit",gridlines:{count:6}},hAxis:{title:"Date"}},s.formatters={},e.chart1=s}]).controller("editBuildingCtrl",["$scope","$rootScope","$log","$routeParams","$cookies","$location","$anchorScroll","Building","Adsservice",function(e,o,t,r,i,n,a,c){angular.element(document).ready(function(){o.checkpermission()}),e.building={},c.get({building_id:r.building_id},function(o){e.building=o}),e.editbuilding=function(){e.building.user_ref?c.post({building:e.building},function(e){t.warn(e),c.query({user_ref:i.UID},function(e){o.building_list=e,o.initwaiting=1,n.path("manage_building"),n.replace()})}):alert("กรุณา login หรือ หรือเปิดใช้งาน Cookies หากขัดข้องกรุณาติดต่อเจ้าหน้าที่")}}]).controller("editRoomCtrl",["$scope","$rootScope","$log","$routeParams","$cookies","$location","$anchorScroll","Building","Room","InventoryApi","UtilityApi",function(e,o,t,r,i,n,a,c,l,s,p){angular.element(document).ready(function(){o.checkpermission()}),e.inventory_list=[],e.inventory_room_list=[],e.utility_room_list=[],e.utility_list=[],e.room={},e.room.images=[],e.services=[],l.get({_id:r.room_id},function(o){if(e.room=o,e.room.images||(e.room.images=[]),e.room.utility_list)for(var t=0;t<e.room.utility_list.length;t++)e.utility_room_list.push({utility_name:e.room.utility_list[t]});if(e.room.inventory_list)for(var t=0;t<e.room.inventory_list.length;t++)e.inventory_room_list.push({inventory_name:e.room.inventory_list[t]});e.services=e.room.service}),e.imagesupload=function(o){var t=new FormData;if(o.type.match("image.*"));else{t.append("image",o.files[0]);var r=new XMLHttpRequest;r.upload.onprogress=function(e){var o=e.loaded/e.total*100;document.getElementById("process_bar").style.width=o+"%"},r.onload=function(){200==r.status?(e.room.images.push(r.responseText),e.$apply()):alert("Error! Upload failed")},r.onerror=function(){alert("Error! Upload failed. Can not connect to server.")},r.open("POST","/resizeimage"),r.send(t)}},s.query({building_ref:r.building_id},function(o){o.$resolved&&(e.inventory_list=o,t.log("test inventory List"),t.log(e.inventory_list))}),p.query({building_ref:r.building_id},function(o){o.$resolved&&(e.utility_list=o,t.log("test utility_list List"),t.log(e.utility_list))}),e.editroom=function(){if(i.UID){e.room.inventory_list=[];for(var o=0;o<e.inventory_room_list.length;o++)e.room.inventory_list.push(e.inventory_room_list[o].inventory_name._id);e.room.utility_list=[];for(var o=0;o<e.utility_room_list.length;o++)e.room.utility_list.push(e.utility_room_list[o].utility_name._id);t.warn(e.services),t.log(e.room),e.room.room_rate_daily=parseInt(e.room.room_rate_daily),e.room.service=e.services,l.post({room:e.room},function(e){t.warn(e),n.path("/manage_room").search("building_id="+e.building_ref),n.replace()})}else alert("กรุณา login หรือ หรือเปิดใช้งาน Cookies หากขัดข้องกรุณาติดต่อเจ้าหน้าที่")}}]).controller("EditPropertyCtrl",["$scope","$rootScope","$log","$routeParams","$cookies","$location","$anchorScroll","Building","Adsservice","PropertyApi",function(e,o,t,r,i,n,a,c,l,s){e.bank_details=[],angular.element(document).ready(function(){o.checkpermission()}),s.get({_id:r.property_id},function(o){e.post=o,void 0===o.location[0]&&(e.post.location[0]=0),void 0===o.location[1]&&(e.post.location[1]=0),e.post.bank_detail?e.bank_details=e.post.bank_detail:e.post.bank_detail=[],t.log("post"),t.log(e.post)}),e.getlocation=function(){navigator.geolocation?navigator.geolocation.getCurrentPosition(function(o){e.post.location[1]=o.coords.latitude,e.post.location[0]=o.coords.longitude}):alert("กรุณาเปิด GPS ด้วยนะ")},e.isDuplicate=function(){Duplicate.query({namespace:e.post.namespace},function(o){if(o.status)e.duplicatestatus=!1;else try{o.data&&o.data._id!==e.up._id.toString()?(e.register.namespace.$error.pattern=!0,e.duplicatestatus=!0):e.duplicatestatus=!1}catch(t){e.duplicatestatus=!0}})},e.logoupload=function(o){var t=new FormData;if(o.type.match("image.*"));else{t.append("image",o.files[0]);var r=new XMLHttpRequest;r.upload.onprogress=function(e){var o=e.loaded/e.total*100;document.getElementById("process_bar").style.width=o+"%"},r.onload=function(){200==r.status?(e.post.logo=r.responseText,e.$apply()):alert("Error! Upload failed")},r.onerror=function(){alert("Error! Upload failed. Can not connect to server.")},r.open("POST","/resizeimage"),r.send(t)}},e.imageheaderupload=function(o){var t=new FormData;if(o.type.match("image.*"));else{t.append("image",o.files[0]);var r=new XMLHttpRequest;r.upload.onprogress=function(e){var o=e.loaded/e.total*100;document.getElementById("process_bar").style.width=o+"%"},r.onload=function(){200==r.status?(e.post.image_header=r.responseText,e.$apply()):alert("Error! Upload failed")},r.onerror=function(){alert("Error! Upload failed. Can not connect to server.")},r.open("POST","/resizeimage"),r.send(t)}},e.imagesupload=function(o){var t=new FormData;if(o.type.match("image.*"));else{t.append("image",o.files[0]);var r=new XMLHttpRequest;r.upload.onprogress=function(e){var o=e.loaded/e.total*100;document.getElementById("process_bar").style.width=o+"%"},r.onload=function(){200==r.status?(e.post.images.push(r.responseText),e.$apply()):alert("Error! Upload failed")},r.onerror=function(){alert("Error! Upload failed. Can not connect to server.")},r.open("POST","/resizeimage"),r.send(t)}},e.editproperty=function(){e.post.bank_detail=e.bank_details,s.post(e.post,function(e){t.warn(e),n.path("manage_property"),n.replace()})}}]).controller("ConfirmRentCtrl",["$window","$filter","$scope","$rootScope","$log","$routeParams","$cookies","$location","$anchorScroll","Building","Room","PropertyApi","CustomerApi","TransactionApi",function(e,o,t,r,i,n,a,c,l,s,p,d,u,_){if(angular.element(document).ready(function(){r.checkpermission();var e="example1234";e=e.toUpperCase(),t.codetoupper=e,$("#bar_key").barcode(r.transaction.customer_ref.toUpperCase(),"code39"),$("#bar_key2").barcode(t.codetoupper,"code39"),console.log("dghkjfblafnblkNSBlkSNFBLwfljbSLFB;SDMBLjNSFLBkS:FNV,SADC;nsFbjlnszlkvlksDNV"),console.log(r.transaction)}),t.roomid=n.room_id,t.select={person:{}},t.confirmwaiting=0,t.confirm_submit=function(){t.confirmwaiting=1,delete r.post._id;for(var e=r.building_list.length-1;e>=0;e--)r.building_list[e]._id===r.post.building_ref&&(r.post.property_ref=r.building_list[e].property_ref);r.transaction.transaction_type="1",r.transaction.transaction_step=2,_.post(r.transaction,function(e){console.log(e),e&&e._id?(p.post({confirm:e.room_ref,room_status:1},function(e){i.log(e)}),t.confirmwaiting=0,c.path("print_report_booking").search("transaction_id="+e._id),c.replace()):alert("error")})},t.customerquerylist=[],r.select)if(r.select.person){for(var m in r.select.person)r.select.person[m]&&t.customerquerylist.push(m);0===t.customerquerylist.length?(c.path("select_customer"),c.replace()):1===t.customerquerylist.length?u.get({_id:t.customerquerylist[0]},function(e){t.customer_list=[],t.customer_list.push(e),i.warn(t.customer_list)}):u.query({person_list:t.customerquerylist},function(e){t.customer_list=e,i.warn(t.customer_list)})}else c.path("select_customer"),c.replace();else c.path("select_customer"),c.replace()}]).controller("ManageBillingCtrl",["$scope","$rootScope","$log","$routeParams","$cookies","$location","$anchorScroll","Building","Room","CustomerApi","TransactionApi",function(e,o,t,r,i,n,a,c,l,s,p){o.checkpermission(),e.searchinvoice="",e.select={person:{}},e.search_invoice_by_key=function(o){console.log(o.keyCode),13==o.keyCode&&e.searchinvoice.length>18?(n.path("/print_report").search("transaction_id="+e.searchinvoice),n.replace()):13!=o.keyCode||isNaN(e.searchinvoice)||(n.path("/print_report").search("tel="+e.searchinvoice),n.replace())},e.search_receipt_by_key=function(o){console.log(o.keyCode),13==o.keyCode&&e.searchreceipt.length>18?(n.path("/print_report_vat").search("transaction_id="+e.searchreceipt),n.replace()):13!=o.keyCode||isNaN(e.searchreceipt)||(n.path("/print_report").search("tel="+e.searchinvoice),n.replace())},e.search_invoice=function(){console.log(e.searchinvoice),e.searchinvoice&&(n.path("/cashier_invoice").search("pay_id="+e.searchinvoice),n.replace())},l.query({building_ref:r.building_id},function(o){e.room_list=o,e.waiting=1}),e.callreport=function(e){n.path("print_report_booking").search("transaction_id="+e)},p.query("",function(o){e.transaction_list=o,t.info(e.transaction_list)}),s.query({parent:i.UID},function(o){e.customer_list=o,t.warn(e.customer_list)})}]).controller("ManageDurableCtrl",["$scope","$rootScope","$log","$routeParams","$cookies","$location","$anchorScroll","InventoryApi",function(e,o,t,r,i,n,a,c){e.buildingid=r.building_id,angular.element(document).ready(function(){o.checkpermission(),e.select_building=function(e){n.path("manage_durable").search("building_id="+e),n.replace()},e.del=function(o,t){var r=confirm("คุณต้องการลบ "+t+" ออกจากระบบ");1==r&&c.remove({_id:o},function(t){if(t.$resolved)for(var r=0;r<e.inventory_list.length;r++)e.inventory_list[r]._id===o&&e.inventory_list.splice(r,1)})},c.query({building_ref:e.buildingid},function(o){o.$resolved&&(e.inventory_list=o,t.log(e.inventory_list))})})}]).controller("AddDurableCtrl",["$scope","$rootScope","$log","$routeParams","$cookies","$location","$anchorScroll","InventoryApi",function(e,o,t,r,i,n,a,c){e.buildingid=r.building_id,angular.element(document).ready(function(){o.checkpermission(),r.durable_id&&c.get({_id:r.durable_id},function(o){e.post=o}),e.building_id=r.building_id,e.insert=function(){e.post.building_ref=e.building_id,c.post(e.post,function(o){o.$resolved&&n.path("/manage_durable").search("building_id="+e.building_id)})}})}]).controller("ManageEmployeeCtrl",["$scope","$rootScope","$log","$routeParams","$cookies","$location","$anchorScroll","Building","Room","CustomerApi","TransactionApi",function(e,o,t,r,i,n){e.buildingid=r.building_id,e.select_building=function(e){n.path("/manage_durable").search("building_id="+e),n.replace()}}]).controller("EditDurableCtrl",["$scope","$rootScope","$log","$routeParams","$cookies","$location","$anchorScroll","InventoryApi",function(e,o,t,r,i,n,a,c){e.buildingid=r.building_id,angular.element(document).ready(function(){o.checkpermission(),r.durable_id&&c.get({_id:r.durable_id},function(o){e.post=o}),e.building_id=r.building_id,e.update=function(){c.post(e.post,function(o){o.$resolved&&n.path("/manage_durable").search("building_id="+e.building_id)})}})}]).controller("ManageUtilityCtrl",["$scope","$rootScope","$log","$routeParams","$cookies","$location","$anchorScroll","UtilityApi",function(e,o,t,r,i,n,a,c){e.buildingid=r.building_id,angular.element(document).ready(function(){o.checkpermission(),e.select_building=function(e){n.path("manage_utility").search("building_id="+e),n.replace()},e.del=function(o,t){var r=confirm("คุณต้องการลบ "+t+" ออกจากระบบ");1==r&&c.remove({_id:o},function(t){if(t.$resolved)for(var r=0;r<e.utility_list.length;r++)e.utility_list[r]._id===o&&e.utility_list.splice(r,1)})},c.query({building_ref:e.buildingid},function(o){o.$resolved&&(e.utility_list=o,t.log(e.utility_list))})})}]).controller("ManageStatementCtrl",["$scope","$rootScope","$log","$routeParams","$cookies","$location","$anchorScroll","Building","TransactionApi","CustomerApi","CreateTransaction",function(e,o,t,r,i,n,a,c,l,s,p){angular.element(document).ready(function(){o.checkpermission()}),p.query({list:""},function(o){console.log(o),e.userpayment=o}),p.get({balance:""},function(o){console.log(o),e.balance=o})}]).controller("PrintReportElectWaterCtrl",["$scope","$rootScope","$log","$routeParams","$cookies","$location","$anchorScroll","Building","Room","CustomerApi","CreateTransaction","ServerTime",function(e,o,t,r,i,n,a,c,l,s,p,d){angular.element(document).ready(function(){o.checkpermission()}),e.water_total=0,e.elect_total=0,e.water_total_vat=0,e.elect_total_vat=0,l.query({utillity_report:r.apartment_id},function(o){if(o.$resolved){e.report_list=o;for(var t=0;t<e.report_list.length;t++)e.temp_water=e.report_list[t].water_meter,e.temp_elect=e.report_list[t].elect_meter,e.water_total+=(e.temp_water[0].water_meter-e.temp_water[1].water_meter)*e.report_list[t].room_water_extra,e.elect_total+=(e.temp_elect[0].elect_meter-e.temp_elect[1].elect_meter)*e.report_list[t].room_energy_extra,e.water_total_vat+=(e.temp_water[0].water_meter-e.temp_water[1].water_meter)*e.report_list[t].room_water_extra-(e.temp_water[0].water_meter-e.temp_water[1].water_meter)*e.report_list[t].room_water_extra/1.07,e.elect_total_vat+=(e.temp_elect[0].elect_meter-e.temp_elect[1].elect_meter)*e.report_list[t].room_energy_extra-(e.temp_elect[0].elect_meter-e.temp_elect[1].elect_meter)*e.report_list[t].room_energy_extra/1.07;console.log(e.water_total+" "+e.elect_total),console.log(e.water_total_vat+" "+e.elect_total_vat)}}),d.get("",function(o){console.log(o),e.server_time=o.time}),e.post={}}]).controller("ManageOrderPaymenyCtrl",["$scope","$rootScope","$log","$routeParams","$cookies","$location","$anchorScroll","Building","Room","CustomerApi","CreateTransaction","ServerTime",function(e,o,t,r,i,n,a,c,l,s,p,d){angular.element(document).ready(function(){o.checkpermission()}),l.query({remain:r.apartment_id},function(o){o.$resolved&&(console.log(o),e.report_list=o)}),d.get("",function(o){console.log(o),e.server_time=o.time}),e.post={}}]).controller("PrintReportInvoiceCtrl",["$scope","$rootScope","$log","$routeParams","$cookies","$location","$anchorScroll","Building","Room","CustomerApi","CreateTransaction",function(e,o){angular.element(document).ready(function(){o.checkpermission()}),e.post={}}]).controller("PrintReportIncomeCtrl",["$scope","$rootScope","$log","$routeParams","$cookies","$location","$anchorScroll","Building","Room","CustomerApi","CreateTransaction",function(e,o){angular.element(document).ready(function(){o.checkpermission()}),e.post={}}]).controller("PrintReportRentedCtrl",["$scope","$rootScope","$log","$routeParams","$cookies","$location","$anchorScroll","Building","Room","CustomerApi","CreateTransaction","ServerTime",function(e,o,t,r,i,n,a,c,l,s,p,d){angular.element(document).ready(function(){o.checkpermission()}),l.query({rented_report:r.apartment_id},function(o){if(o.$resolved){console.log(o),e.report_list=o;for(var t=0;t<e.report_list.length;t++)e.report_list[t].customer_ref=void 0===e.report_list[t].customer_ref?{name:"ห้องว่าง",id_card:"ห้องว่าง"}:e.report_list[t].customer_ref}}),d.get("",function(o){console.log(o),e.server_time=o.time}),e.post={}}]).controller("PrintReportMoveOutCtrl",["$scope","$rootScope","$log","$routeParams","$cookies","$location","$anchorScroll","Building","Room","CustomerApi","CreateTransaction","ServerTime",function(e,o,t,r,i,n,a,c,l,s,p,d){angular.element(document).ready(function(){o.checkpermission()}),l.query({moving_out:r.apartment_id},function(o){o.$resolved&&(console.log(o),e.report_list=o)}),d.get("",function(o){console.log(o),e.server_time=o.time}),e.post={}}]).controller("ThankYouCtrl",["$scope","$rootScope","$log","$routeParams","$cookies","$location","$anchorScroll","Building","Room","CustomerApi","CreateTransaction",function(e,o){angular.element(document).ready(function(){o.checkpermission()}),e.post={}}]).controller("AddEventCtrl",["$scope","$rootScope","$log","$routeParams","$cookies","$location","$anchorScroll","Building","Room","CustomerApi","CreateTransaction",function(e,o){angular.element(document).ready(function(){o.checkpermission()}),e.post={}}]).controller("ManageCalendarCtrl",["$scope","$rootScope","$log","$compile","$routeParams","$cookies","$location","$anchorScroll","CalendarApi","uiCalendarConfig",function(e,o,t,r,i,n,a,c,l,s){{var p=new Date;p.getDate(),p.getMonth(),p.getFullYear()}e.events=[],e.eventSources=[],e.alertOnEventClick=function(o){e.alertMessage=alert(o.title+" was clicked ")},e.alertOnDrop=function(o,t){e.alertMessage="Event Droped to make dayDelta "+t},e.alertOnResize=function(o,t){e.alertMessage="Event Resized to make dayDelta "+t},e.addRemoveEventSource=function(e,o){var t=0;angular.forEach(e,function(r,i){e[i]===o&&(e.splice(i,1),t=1)}),0===t&&e.push(o)},e.addEvent=function(){e.calendar_object={title:e.title,textColor:e.color,backgroundColor:e.bgcolor,start:e.startDate,end:e.endDate,user_ref:n.UID},console.log(e.events),l.post(e.calendar_object,function(o){o.$resolved&&e.events.push(e.calendar_object)})},e.remove=function(o){e.events.splice(o,1)},e.changeView=function(e,o){s.calendars[o].fullCalendar("changeView",e)},e.renderCalender=function(e){s.calendars[e]&&s.calendars[e].fullCalendar("render")},e.eventRender=function(o,t){t.attr({tooltip:o.title,"tooltip-append-to-body":!0}),r(t)(e)},e.uiConfig=o.isMobile?{calendar:{height:450,editable:!1,header:{left:"today",center:"",right:"prev,next"},eventLimit:{month:6,"default":!0},defaultView:"basicDay",eventClick:e.alertOnEventClick,eventDrop:e.alertOnDrop,eventResize:e.alertOnResize,eventRender:e.eventRender}}:{calendar:{height:450,editable:!1,header:{left:"title",center:"month,basicWeek,basicDay",right:"today prev,next"},eventLimit:{month:6,"default":!0},monthNames:["มกราคม","กุมภาพันธ์","มีนาคม","เมษายน","พฤษภาคม","มิถุนายน","กรกฎาคม","สิงหาคม","กันยายน","ตุลาคม","พฤศจิกายน","ธันวาคม"],monthNamesShort:["ม.ค.","ก.พ.","มี.ค.","เม.ย.","พ.ค.","มิ.ย.","ก.ค.","ส.ค.","ก.ย.","ต.ค.","พ.ย.","ธ.ค."],dayNames:["อาทิตย์","จักนทร์","อังคาร","พุธร์","พฤหัสบดี","ศุกร์","เสาร์"],dayNamesShort:["อา.","จ.","อ.","พ.","พฤ.","ศ.","ส."],eventClick:e.alertOnEventClick,eventDrop:e.alertOnDrop,eventResize:e.alertOnResize,eventRender:e.eventRender}},angular.element(document).ready(function(){o.checkpermission(),l.query("",function(o){if(o.$resolved){for(var t=0;t<o.length;t++)o[t].start=new Date(o[t].start),e.events.push(o[t]);console.log(o)}})}),e.eventSources=[e.events],e.post={}}]).controller("TopupCtrl",["$scope","$rootScope","$log","$routeParams","$cookies","$location","$anchorScroll","$window","$http","CustomerApi","TransactionApi","CreateTransaction",function(e,o,t,r,i,n,a,c,l,s,p,d){angular.element(document).ready(function(){o.checkpermission()}),e.payment={},e.amount=0,e.invoicestat=!1,e.setamount=function(o){e.amount=o},e.send_payment=function(){console.log(e.payment.amount),d.post({amt:e.amount},function(o){o.invoice&&(console.log(o.invoice),e.payment.inv=o.invoice,console.log(e.payment),e.invoicenumber=o.invoice,e.invoicestat=!0)})}}]).controller("AddUtilityCtrl",["$scope","$rootScope","$log","$routeParams","$cookies","$location","$anchorScroll","UtilityApi",function(e,o,t,r,i,n,a,c){angular.element(document).ready(function(){o.checkpermission(),e.building_id=r.building_id,e.insert=function(){e.post.building_ref=e.building_id,c.post(e.post,function(){n.path("manage_utility").search("building_id="+e.building_id)})}})}]).controller("PrintReceiptMonthlyCtrl",["$scope","$rootScope","$log","$routeParams","$cookies","$location","$anchorScroll","Building","Room","CustomerApi","TransactionApi",function(e,o,t,r,i,n,a,c,l,s,p){angular.element(document).ready(function(){o.checkpermission()}),e.buildingid=r.building_id,e.select_building=function(e){n.path("manage_utility").search("building_id="+e),n.replace()},p.get({transaction_id:r.transaction_id},function(o){e.buildingid=o.building_ref._id,e.post=o,e.pricetostring=$filter("thbToString")(e.post.reserve_price.toString());var r=o._id;r=r.toUpperCase(),e.codetoupper=r,$("#bar_key").barcode(e.codetoupper,"code39"),t.log(o)})}]).controller("EditUtilityCtrl",["$scope","$rootScope","$log","$routeParams","$cookies","$location","$anchorScroll","UtilityApi",function(e,o,t,r,i,n,a,c){angular.element(document).ready(function(){o.checkpermission(),r.utility_id&&c.get({_id:r.utility_id},function(o){e.post=o}),e.building_id=r.building_id,e.update=function(){c.post(e.post,function(o){o.$resolved&&n.path("manage_utility").search("building_id="+e.building_id)})}})}]).controller("MakeRoomCoverageCtrl",["$scope","$filter","$rootScope","$log","$routeParams","$cookies","$location","$anchorScroll","Building","Room","CustomerApi","TransactionApi",function(e,o,t,r,i,n,a,c,l,s,p,d){angular.element(document).ready(function(){t.checkpermission()}),e.buildingid=i.building_id,e.select_building=function(e){a.path("manage_utility").search("building_id="+e),a.replace()},d.get({transaction_id:i.transaction_id},function(t){e.buildingid=t.building_ref._id,e.post=t,e.pricetostring=o("thbToString")(e.post.reserve_price.toString());var i=t._id;i=i.toUpperCase(),e.codetoupper=i,$("#bar_key").barcode(e.codetoupper,"code39"),r.log(t)})}]).controller("PrintRoomCoverageCtrl",["$scope","$filter","$rootScope","$log","$routeParams","$cookies","$location","$anchorScroll","Building","Room","CustomerApi","TransactionApi",function(e,o,t,r,i,n,a,c,l,s,p,d){angular.element(document).ready(function(){t.checkpermission()}),e.buildingid=i.building_id,e.select_building=function(e){a.path("manage_utility").search("building_id="+e),a.replace()},d.get({transaction_id:i.transaction_id},function(t){e.buildingid=t.building_ref._id,e.post=t,e.pricetostring=o("thbToString")(e.post.reserve_price.toString());var i=t._id;i=i.toUpperCase(),e.codetoupper=i,$("#bar_key").barcode(e.codetoupper,"code39"),r.log(t)})}]).controller("MakeRoomChecklist",["$scope","$rootScope","$log","$routeParams","$cookies","$location","$anchorScroll","Building","Room","CustomerApi","TransactionApi",function(e,o,t,r,i,n,a,c,l,s,p){e.post=[],e.payment_list=[],e.item=[{name:"ค่ามัดจำ",price:500},{name:"ค่าประกัน",price:1e4},{name:"คาคีย์การ์ด",price:100},{name:"อินเตอร์เน็ต",price:300},{name:'ทีวี 21"',price:100}],e.post.payment_this=[],e.post.date=new Date,angular.element(document).ready(function(){o.checkpermission()}),p.get({transaction_id:r.transaction_id},function(o){e.buildingid=o.building_ref._id,e.post=o,e.pricetostring=$filter("thbToString")(e.post.reserve_price.toString());var r=o._id;r=r.toUpperCase(),e.codetoupper=r,$("#bar_key").barcode(e.codetoupper,"code39"),t.log(o)})}]).controller("PrintRoomChecklist",["$scope","$rootScope","$log","$routeParams","$cookies","$location","$anchorScroll","Building","Room","CustomerApi","TransactionApi",function(e,o,t,r,i,n,a,c,l,s,p){e.post=[],e.payment_list=[],e.item=[{name:"ค่ามัดจำ",price:500},{name:"ค่าประกัน",price:1e4},{name:"คาคีย์การ์ด",price:100},{name:"อินเตอร์เน็ต",price:300},{name:'ทีวี 21"',price:100}],e.post.payment_this=[],e.post.date=new Date,angular.element(document).ready(function(){o.checkpermission()}),p.get({transaction_id:r.transaction_id},function(o){e.buildingid=o.building_ref._id,e.post=o,e.pricetostring=$filter("thbToString")(e.post.reserve_price.toString());var r=o._id;r=r.toUpperCase(),e.codetoupper=r,$("#bar_key").barcode(e.codetoupper,"code39"),t.log(o)})}]).controller("RoomDetailCtrl",["$scope","$rootScope","$log","$routeParams","$cookies","$location","$anchorScroll","Building","Room","CustomerApi","CalendarApi","ElectApi","WaterApi","TransactionApi",function(e,o,t,r,i,n,a,c,l,s,p,d,u,_){o.checkpermission(),e.room_id=r.room_id,e.select={person:{}};for(var m=0;13>m;m++)e["water_meter"+m]={},e["elect_meter"+m]={};_.query({room_id:r.room_id},function(o){o.$resolved&&(e.room_transaction=o)}),e.water_query=function(o){o-=1,u.query({meter_room_ref:r.room_id,limit:100,year:2014,month:o},function(r){r.$resolved&&(t.log("water Api"),t.log(r),e["water_meter"+(o+1)]=r)})},e.elect_query=function(o){o-=1,d.query({meter_room_ref:r.room_id,limit:100,year:2014,month:o},function(r){r.$resolved&&(t.log("elect Api"),t.log(r),e["elect_meter"+(o+1)]=r)})},e.events=[],u.query({meter_room_ref:r.room_id,limit:100,year:2014,month:1},function(o){o.$resolved&&(t.log("water Api"),t.log(o),e.water_meter=o)}),d.query({meter_room_ref:r.room_id,limit:100,year:2014,month:1},function(o){o.$resolved&&(t.log("Elect Api"),t.log(o),e.elect_meter=o)}),e.eventSources=[],e.changeView=function(e,o){uiCalendarConfig.calendars[o].fullCalendar("changeView",e)},e.renderCalender=function(e){uiCalendarConfig.calendars[e]&&uiCalendarConfig.calendars[e].fullCalendar("render")},e.eventRender=function(o,t){t.attr({tooltip:o.title,"tooltip-append-to-body":!0}),$compile(t)(e)},e.uiConfig=o.isMobile?{calendar:{height:450,editable:!1,header:{left:"today",center:"",right:"prev,next"},eventLimit:{month:6,"default":!0},defaultView:"basicDay",eventClick:e.alertOnEventClick,eventDrop:e.alertOnDrop,eventResize:e.alertOnResize,eventRender:e.eventRender}}:{calendar:{height:450,editable:!1,header:{left:"title",center:"month,basicWeek,basicDay",right:"today prev,next"},eventLimit:{month:6,"default":!0},monthNames:["มกราคม","กุมภาพันธ์","มีนาคม","เมษายน","พฤษภาคม","มิถุนายน","กรกฎาคม","สิงหาคม","กันยายน","ตุลาคม","พฤศจิกายน","ธันวาคม"],monthNamesShort:["ม.ค.","ก.พ.","มี.ค.","เม.ย.","พ.ค.","มิ.ย.","ก.ค.","ส.ค.","ก.ย.","ต.ค.","พ.ย.","ธ.ค."],dayNames:["อาทิตย์","จักนทร์","อังคาร","พุธร์","พฤหัสบดี","ศุกร์","เสาร์"],dayNamesShort:["อา.","จ.","อ.","พ.","พฤ.","ศ.","ส."],eventClick:e.alertOnEventClick,eventDrop:e.alertOnDrop,eventResize:e.alertOnResize,eventRender:e.eventRender}},e.eventSources=[e.events],l.get({_id:r.room_id},function(o){if(e.room=o,e.room.images||(e.room.images=[]),e.room.utility_list)for(var t=0;t<e.room.utility_list.length;t++)e.utility_room_list.push({utility_name:e.room.utility_list[t]});if(e.room.inventory_list)for(var t=0;t<e.room.inventory_list.length;t++)e.inventory_room_list.push({inventory_name:e.room.inventory_list[t]});e.services=e.room.service}),s.query({parent:i.UID},function(o){e.customer_list=o,t.warn(e.customer_list)})}]).controller("UpdatePaymentCtrl",["$scope","$rootScope","$log","$routeParams","$cookies","$location","$anchorScroll","Building","Room","CustomerApi",function(e,o,t,r,i,n,a,c,l,s){o.checkpermission(),e.select={person:{}},l.query({building_ref:r.building_id},function(o){e.room_list=o,e.waiting=1}),s.query({parent:i.UID},function(o){e.customer_list=o,t.warn(e.customer_list)})}]).controller("ManageWaterCtrl",["$scope","$rootScope","$log","$routeParams","$cookies","$location","$anchorScroll","Building","Room","CustomerApi","WaterApi",function(e,o,t,r,i,n,a,c,l,s,p){o.checkpermission(),e.csv_array={},e.compare=function(){for(var o=0;o<e.room_list.length;o++)e.room_list[o].post.water_meter=parseFloat(e.csv_array[e.room_list[o].room_name]),console.log(e.csv_array[e.room_list[o].room_name]);console.log(e.room_list)},e.$watch("csv_array",function(e,o){console.log(e),console.log(o)}),e.save_all_csv=function(){for(var o=0;o<e.room_list.length;o++)e.insert(e.room_list[o]._id)},e.upload_csv=function(o){var t=o.files[0];if(console.log(t),"text/csv"===t.type){var r=new FileReader;r.onload=function(o){console.log(o);for(var t=o.target.result,r=0;r<t.split(/\n/g).length;r++)void 0!==t.split(/\n/g)[r].split(",")[6]?e.csv_array[t.split(/\n/g)[r].split(",")[0]]=t.split(/\n/g)[r].split(",")[6]:2==t.split(/\n/g)[r].split(",").length&&void 0!==t.split(/\n/g)[r].split(",")[1]&&(e.csv_array[t.split(/\n/g)[r].split(",")[0]]=t.split(/\n/g)[r].split(",")[1]);e.compare()},r.readAsText(t),console.log(e.csv_array)}else alert("Failed to load file")},e.select={person:{}},l.query({building_ref:r.building_id},function(o){e.room_list=o,t.log(e.room_list);for(var r=0;r<e.room_list.length;r++)e.room_list[r].post={water_meter:0},t.log(e.room_list[r]),p.query({room_ref:e.room_list[r]._id,limit:2},function(o){for(var t=e.room_list.length-1;t>=0;t--)try{e.room_list[t]._id===o[0].room_ref._id&&(e.room_list[t].before_water_bill=o[1],e.room_list[t].after_water_bill=o[0],e.room_list[t].post.water_meter=o[0].water_meter)}catch(r){}})}),e.insert=function(o){e.water={},e.water.room_ref=o;for(var t=e.room_list.length-1;t>=0;t--)e.room_list[t]._id===o&&(e.water.water_meter=e.room_list[t].post.water_meter);p.post(e.water,function(){})},e.edit_meter=function(o){for(var t=e.room_list.length-1;t>=0;t--)e.room_list[t]._id===o&&(e.edit_meter_value={},e.edit_meter_value.water_meter=e.room_list[t].edit.after_water_bill.water_meter,e.edit_meter_value._id=e.room_list[t].after_water_bill._id,p.post(e.edit_meter_value,function(t){if(t.$resolved)for(var r=e.room_list.length-1;r>=0;r--)e.room_list[r]._id===o&&(e.room_list[r].after_water_bill.water_meter=t.water_meter)}))},s.query({parent:i.UID},function(o){e.customer_list=o,t.warn(e.customer_list)}),e.select_building=function(e){n.path("manage_water").search("building_id="+e),n.replace()}}]).controller("ManageElecCtrl",["$scope","$rootScope","$log","$routeParams","$cookies","$location","$anchorScroll","Building","Room","CustomerApi","ElectApi",function(e,o,t,r,i,n,a,c,l,s,p){e.list={},e.list.post={},e.csv_array={},angular.element(document).ready(function(){o.checkpermission()}),e.compare=function(){for(var o=0;o<e.room_list.length;o++)e.room_list[o].post.elect_meter=parseFloat(e.csv_array[e.room_list[o].room_name]);e.$apply(),console.log(e.room_list)},e.save_all_csv=function(){for(var o=0;o<e.room_list.length;o++)e.insert(e.room_list[o]._id)},e.$watch("csv_array",function(e,o){console.log(e),console.log(o)}),e.upload_csv=function(o){var t=o.files[0];if(console.log(t),"text/csv"===t.type){var r=new FileReader;
r.onload=function(o){console.log(o);for(var t=o.target.result,r=0;r<t.split(/\n/g).length;r++)void 0!==t.split(/\n/g)[r].split(",")[6]?e.csv_array[t.split(/\n/g)[r].split(",")[0]]=t.split(/\n/g)[r].split(",")[6]:2==t.split(/\n/g)[r].split(",").length&&void 0!==t.split(/\n/g)[r].split(",")[1]&&(e.csv_array[t.split(/\n/g)[r].split(",")[0]]=t.split(/\n/g)[r].split(",")[1]);e.compare()},console.log(e.csv_array),r.readAsText(t)}else alert("Failed to load file")},e.select={person:{}},l.query({building_ref:r.building_id},function(o){e.room_list=o;for(var t=0;t<e.room_list.length;t++)e.room_list[t].post={},p.query({room_ref:e.room_list[t]._id,limit:2},function(o){for(var t=e.room_list.length-1;t>=0;t--)try{e.room_list[t]._id===o[0].room_ref._id&&(e.room_list[t].before_elect_bill=o[1],e.room_list[t].after_elect_bill=o[0],e.room_list[t].post.elect_meter=o[0].elect_meter)}catch(r){}})}),e.insert=function(o){e.elect={},e.elect.room_ref=o;for(var t=e.room_list.length-1;t>=0;t--)e.room_list[t]._id===o&&(e.elect.elect_meter=e.room_list[t].post.elect_meter);p.post(e.elect,function(){})},e.edit_meter=function(o){for(var t=e.room_list.length-1;t>=0;t--)e.room_list[t]._id===o&&(e.edit_meter_value={},e.edit_meter_value.elect_meter=e.room_list[t].edit.after_elect_bill.elect_meter,e.edit_meter_value._id=e.room_list[t].after_elect_bill._id,p.post(e.edit_meter_value,function(t){if(t.$resolved)for(var r=e.room_list.length-1;r>=0;r--)e.room_list[r]._id===o&&(e.room_list[r].after_elect_bill.elect_meter=t.elect_meter)}))},s.query({parent:i.UID},function(o){e.customer_list=o,t.warn(e.customer_list)}),e.select_building=function(e){n.path("manage_elec").search("building_id="+e),n.replace()}}]).controller("CustomerBillingCtrl",["$scope","$rootScope","$log","$routeParams","$cookies","$location","$anchorScroll","Building","Room","TransactionApi","CustomerApi",function(e,o,t,r,i,n,a,c,l,s,p){angular.element(document).ready(function(){o.checkpermission()}),e.select={person:{}},void 0!==r.room_id?s.query({room_id:r.room_id},function(o){o&&o.length?s.query({ref_id:o[0]._id},function(t){e.transaction_list=t&&t.length?t:o}):e.transaction_list=o}):void 0!==r.customer_id&&(s.query({customer_id:r.customer_id},function(o){o&&o.length?s.query({ref_id:o[0]._id},function(t){e.transaction_list=t&&t.length?t:o}):e.transaction_list=o}),p.get({_id:r.customer_id},function(o){e.customer_detail=o,t.log(o)})),s.query({customer_id:r.customer_id},function(o){o&&o.length?s.query({ref_id:o[0]._id},function(t){e.transaction_list=t&&t.length?t:o}):e.transaction_list=o})}]).controller("AddPropertyCtrl",["$scope","$rootScope","$log","$routeParams","$cookies","$location","$anchorScroll","Building","Adsservice","PropertyApi","Duplicate",function(e,o,t,r,i,n,a,c,l,s,p){angular.element(document).ready(function(){o.checkpermission()}),11==i.Permission?(console.log("test"),e.post={images:[],location:[],title:"Demo Apartment",address:"12/345 มีนบุรี กรุงเทพมหานคร 10230",contact_email:"demouser@email.com",contact_name:"พนักงาน",contact_mobile:"0860000000",contact_tel:"020000000",contact_fax:"020000000",no_room:"30",price_min:"5000",dailyprice:"400",demo:!0}):(e.post={},e.post.images=[],e.post.location=[]),e.getlocation=function(){navigator.geolocation?navigator.geolocation.getCurrentPosition(function(o){e.post.location[1]=o.coords.latitude,e.post.location[0]=o.coords.longitude}):alert("กรุณาเปิด GPS ด้วยนะ")},e.isDuplicate=function(){p.query({namespace:e.post.namespace},function(o){if(o.status)e.duplicatestatus=!1;else try{o.data&&o.data._id!==e.up._id.toString()?(e.register.namespace.$error.pattern=!0,e.duplicatestatus=!0):e.duplicatestatus=!1}catch(r){e.duplicatestatus=!0,t.log(e.duplicatestatus),t.log(r)}})},e.logoupload=function(o){var t=new FormData;if(o.type.match("image.*"));else{t.append("image",o.files[0]);var r=new XMLHttpRequest;r.upload.onprogress=function(e){e.loaded/e.total*100},r.onload=function(){200==r.status?(e.post.logo=r.responseText,e.$apply()):alert("Error! Upload failed")},r.onerror=function(){alert("Error! Upload failed. Can not connect to server.")},r.open("POST","/resizeimage"),r.send(t)}},e.imageheaderupload=function(o){var t=new FormData;if(o.type.match("image.*"));else{t.append("image",o.files[0]);var r=new XMLHttpRequest;r.upload.onprogress=function(e){e.loaded/e.total*100},r.onload=function(){200==r.status?(e.post.image_header=r.responseText,e.$apply()):alert("Error! Upload failed")},r.onerror=function(){alert("Error! Upload failed. Can not connect to server.")},r.open("POST","/resizeimage"),r.send(t)}},e.imagesupload=function(o){var t=new FormData;if(o.type.match("image.*"));else{t.append("image",o.files[0]);var r=new XMLHttpRequest;r.upload.onprogress=function(e){e.loaded/e.total*100},r.onload=function(){200==r.status?(e.post.images.push(r.responseText),e.$apply()):alert("Error! Upload failed")},r.onerror=function(){alert("Error! Upload failed. Can not connect to server.")},r.open("POST","/resizeimage"),r.send(t)}},e.insert=function(){s.post(e.post,function(e){t.warn(e),n.path("manage_property"),n.replace()})}}]).controller("ReportCtrl",["$scope","$rootScope","$log","$routeParams","$cookies","$location","$anchorScroll","Building","Room","TransactionApi","Adsservice","InvoiceApi",function(e,o,t,r,i,n,a,c,l,s,p,d){angular.element(document).ready(function(){o.checkpermission(),e.make_invoice=function(e){d.post({make_invoice:e},function(o){o.$resolved&&(n.path("print_report").search("property_id="+e),n.replace())})},e.select_building=function(e){n.path("manage_report").search("building_id="+e),n.replace()},e.status_list=[],p.query({user_id:i.UID},function(o){e.property_list=o;for(var t=0;t<e.property_list.length;t++)s.get({check_status:e.property_list[t]._id},function(o){o.$resolved&&e.status_list.push(o)});console.log(o)}),setTimeout(function(){for(var o=0;o<e.property_list.length;o++)for(var t=0;t<e.status_list.length;t++)console.log(e.property_list[o]),console.log(e.status_list[t]),e.property_list[o]._id===e.status_list[t]._id&&(e.property_list[o].check_status=e.status_list[t].status);e.$apply(),console.log(e.property_list)},2e3)})}]).controller("SelectCustomerCtrl",["$scope","$rootScope","$log","$routeParams","$cookies","$location","$anchorScroll","Building","Room","CustomerApi",function(e,o,t,r,i,n,a,c,l,s){angular.element(document).ready(function(){o.checkpermission()}),e.roomid=r.room_id,o.select={person:{}},l.query({building_ref:r.building_id},function(o){e.room_list=o,e.waiting=1}),s.query({parent:i.UID},function(o){e.customer_list=o,t.warn(e.customer_list)})}]).controller("SelectRentTypeCtrl",["$scope","$filter","$rootScope","$log","$routeParams","$cookies","$location","$anchorScroll","Building","Room","CustomerApi","ElectApi","WaterApi","TransactionApi","SendNotification","CalendarApi",function(e,o,t,r,i,n,a,c,l,s,p,d,u,_,m,g){angular.element(document).ready(function(){e.customerquerylist=[],t.checkpermission(),e.roomid=i.room_id,t.customer={},t.building={},t.property={},t.transaction={},t.room={},t.post={},t.transaction.reserve_price="0",e.smsconfirm=0;var c="example1234";if(c=c.toUpperCase(),e.codetoupper=c,$("#bar_key").barcode(e.codetoupper,"code39"),$("#bar_key2").barcode(e.codetoupper,"code39"),t.$watch("post.customer_ref",function(){try{for(var o=e.customer_list.length-1;o>=0;o--)e.customer_list[o]._id.toString()===e.post.customer_ref.toString()&&($("#bar_key").barcode(e.customer_list[o]._id,"code39"),t.transaction.customer_ref=e.customer_list[o]._id,t.customer=e.customer_list[o],t.customer.birth_date=new Date(t.customer.birth_date))}catch(r){}}),e.makebooking=function(){t.transaction.accompany=[];for(var o=e.customer_list.length-1;o>=0;o--)t.transaction.accompany.push(e.customer_list[o]._id);t.transaction.reserve_price=t.force_reserve_price,t.transaction.room_ref=e.roomid,t.transaction.user_ref=n.UID,_.post(e.transaction,function(o){o&&(e.smsbody={},e.smsbody.email=t.property.contact_email,e.smsbody.tel=t.property.contact_mobile,e.smsbody.message=t.property.title+" ห้อง "+t.room.room_no+" ถูกจองโดย "+e.customer_list[0].name+" "+e.customer_list[0].last_name,console.log(e.smsbody),0==e.smsconfirm&&(e.smsconfirm++,m.post(e.smsbody,function(e){console.log(e)}),e.calendar_object={title:" ห้อง "+t.room.room_no+" ถูกจอง",textColor:"white",backgroundColor:"#4b98ed",start:Date.now(),user_ref:n.UID},g.post(e.calendar_object,function(){}),e.calendar_object={title:" ห้อง "+t.room.room_no+" นัดย้ายเข้า",textColor:"white",backgroundColor:"#d86a9b",start:t.transaction.move_in_date,user_ref:n.UID},g.post(e.calendar_object,function(){})),t.transaction=o,t.customer=o.customer_ref,t.building=o.building_ref,t.room=o.room_ref,t.property=o.property_ref,console.log(o),s.post({confirm:o.room_ref,room_status:1},function(e){r.log(e)}),a.path("print_receipt_booking").search("transaction_id="+o._id),a.replace()),r.log(o)})},t.$watch("transaction.reserve_price",function(e,r){try{console.log(e+"--------------"+r),t.pricetostring=o("thbToString")(t.transaction.reserve_price),console.log(t.transaction),t.force_reserve_price=e}catch(i){}}),s.get({get_property:e.roomid},function(e){e&&(console.log(e),t.property.coverage=isNaN(e.deposite)?0:parseInt(e.deposite),t.property.common_fee_charge=isNaN(e.utility)?0:parseInt(e.utility),t.property.furniture=isNaN(e.room_furniture)?0:parseInt(e.room_furniture),t.property.car_park_fee=isNaN(e.parking)?0:parseInt(e.parking),t.property.internet_fee=isNaN(e.net_bill)?0:parseInt(e.net_bill),t.property.title=e.title,t.property.contact_mobile=e.contact_mobile,t.property.contact_tel=e.contact_tel,t.property.contact_email=e.contact_email,t.property.contact_fax=e.contact_fax,t.property.address=e.address,t.property.property_ref=e._id,t.property.deposit=isNaN(e.deposit)||""===e.deposit?0:parseInt(e.deposit),t.property.price_min=isNaN(e.price_min)||""===e.price_min?0:parseInt(e.price_min))}),s.get({_id:i.room_id},function(e){t.room.room_no=e.room_no,t.room.room_rate=isNaN(e.room_rate)?0:parseInt(e.room_rate);for(var o=t.building_list.length-1;o>=0;o--)t.building_list[o]._id===e.building_ref._id&&(t.transaction.building_ref=t.building_list[o]._id,t.transaction.property_ref=t.building_list[o].property_ref._id,t.building.building=t.building_list[o].building,t.building.building_no=t.building_list[o].building_no,t.building.building_ref=t.building_list[o]._id,t.building.property_ref=t.building_list[o].property_ref._id)}),e.setpost=function(){t.transaction.accompany=[];for(var o=e.customer_list.length-1;o>=0;o--)t.transaction.accompany.push(e.customer_list[o]._id);t.transaction.reserve_price=t.force_reserve_price,t.transaction.room_ref=e.roomid,t.transaction.user_ref=n.UID},t.select)if(t.select.person){for(var l in t.select.person)t.select.person[l]&&e.customerquerylist.push(l);0===e.customerquerylist.length?(a.path("select_customer"),a.replace()):1===e.customerquerylist.length?p.get({_id:e.customerquerylist[0]},function(o){e.customer_list=[],e.customer_list.push(o),t.transaction.customer_ref=e.customer_list[0]._id,t.customer=e.customer_list[0],t.customer.birth_date=new Date(t.customer.birth_date),r.warn(e.customer_list)}):p.query({person_list:e.customerquerylist},function(o){e.customer_list=o,t.transaction.customer_ref=e.customer_list[0]._id,t.customer=e.customer_list[0],t.customer.birth_date=new Date(t.customer.birth_date),r.warn(e.customer_list)})}else a.path("select_customer"),a.replace();else a.path("select_customer"),a.replace();t.transaction.date=new Date,t.transaction.move_in_date=new Date})}]).controller("FormPersonCtrl",["$scope","$rootScope","$log","$routeParams","$cookies","$http","$location","$anchorScroll","CustomerApi","Room",function(e,o,t,r,i,n,a,c,l){angular.element(document).ready(function(){o.checkpermission()}),e.post={},e.getcontent=function(){e.array_person=e.person_area.split("!"),e.post.id_card=parseInt(e.array_person[0]),e.post.birth_date=new Date(e.array_person[1].split("/")[2]-543,e.array_person[1].split("/")[1]-1,e.array_person[1].split("/")[0]),e.post.prefix=e.array_person[3],e.post.name=e.array_person[4],e.post.last_name=e.array_person[5],e.post.id_card_create=new Date(e.array_person[6].split("/")[2]-543,e.array_person[6].split("/")[1]-1,e.array_person[6].split("/")[0]),e.post.id_card_expiry=new Date(e.array_person[7].split("/")[2]-543,e.array_person[7].split("/")[1]-1,e.array_person[7].split("/")[0]),e.post.address_no=e.array_person[8],e.post.address_moo=" "===e.array_person[9]?"-":e.array_person[9],e.post.address_road=e.array_person[11],e.post.address_tumbol=e.array_person[12],e.post.address_aumphur=e.array_person[13],e.post.address_province=e.array_person[14],t.log(e.array_person)},e.insert=function(){e.post.parent=i.UID,l.post(e.post,function(e){t.warn(e),a.path("select_customer").search("room_id="+r.room_id),a.replace()})};var s=new FormData;e.idcarduploadfront=function(o){if(s=new FormData,o.type.match("image.*"));else{s.append("image",o.files[0]);var t=new XMLHttpRequest;t.upload.onprogress=function(e){e.loaded/e.total*100},t.onload=function(){200==t.status?e.post.id_card_pic_front=t.responseText:alert("Error! Upload failed")},t.onerror=function(){alert("Error! Upload failed. Can not connect to server.")},t.open("POST","/idcard"),t.send(s)}},e.idcarduploadback=function(o){if(s=new FormData,o.type.match("image.*"));else{s.append("image",o.files[0]);var t=new XMLHttpRequest;t.upload.onprogress=function(e){e.loaded/e.total*100},t.onload=function(){200==t.status?e.post.id_card_pic_back=t.responseText:alert("Error! Upload failed")},t.onerror=function(){alert("Error! Upload failed. Can not connect to server.")},t.open("POST","/idcard"),t.send(s)}}}]).controller("PersonCtrl",["$scope","$rootScope","$log","$routeParams","$cookies","$http","$location","$anchorScroll","CustomerApi","Room",function(e,o,t,r,i,n,a,c,l){function s(e){var o;o=e.split(",")[0].indexOf("base64")>=0?atob(e.split(",")[1]):unescape(e.split(",")[1]);for(var t=e.split(",")[0].split(":")[1].split(";")[0],r=new Uint8Array(o.length),i=0;i<o.length;i++)r[i]=o.charCodeAt(i);return new Blob([r],{type:t})}angular.element(document).ready(function(){o.checkpermission()}),e.post={},e.getcontent=function(){e.array_person=e.person_area.split("!"),e.post.id_card=parseInt(e.array_person[0]),e.post.birth_date=new Date(e.array_person[1].split("/")[2]-543,e.array_person[1].split("/")[1]-1,e.array_person[1].split("/")[0]),e.post.prefix=e.array_person[3],e.post.name=e.array_person[4],e.post.last_name=e.array_person[5],e.post.id_card_create=new Date(e.array_person[6].split("/")[2]-543,e.array_person[6].split("/")[1]-1,e.array_person[6].split("/")[0]),e.post.id_card_expiry=new Date(e.array_person[7].split("/")[2]-543,e.array_person[7].split("/")[1]-1,e.array_person[7].split("/")[0]),e.post.address_no=e.array_person[8],e.post.address_moo=" "===e.array_person[9]?"-":e.array_person[9],e.post.address_road=e.array_person[11],e.post.address_tumbol=e.array_person[12],e.post.address_aumphur=e.array_person[13],e.post.address_province=e.array_person[14],t.log(e.array_person)},e.callcamera=function(){if(!o.isMobile){var t=document.getElementById("canvas"),r=t.getContext("2d"),i=document.getElementById("video"),n={video:!0},a=function(){};navigator.getUserMedia?navigator.getUserMedia(n,function(e){i.src=e,i.play()},a):navigator.webkitGetUserMedia?navigator.webkitGetUserMedia(n,function(e){i.src=window.webkitURL.createObjectURL(e),i.play()},a):navigator.mozGetUserMedia&&navigator.mozGetUserMedia(n,function(e){i.src=window.URL.createObjectURL(e),i.play()},a),document.getElementById("snap").addEventListener("click",function(){r.drawImage(i,0,0,640,480);var o=t.toDataURL("image/png"),n=s(o),a=new FormData;a.append("image",n);var c=new XMLHttpRequest;c.upload.onprogress=function(e){e.loaded/e.total*100},c.onload=function(){200==c.status?e.post.id_card_pic_front=c.responseText:alert("Error! Upload failed")},c.onerror=function(){alert("Error! Upload failed. Can not connect to server.")},c.open("POST","/idcard"),c.send(a)})}},e.insert=function(){e.post.parent=i.UID,l.post(e.post,function(e){t.warn(e),a.path("manage_customer"),a.replace()})};var p=new FormData;e.idcarduploadfront=function(o){if(p=new FormData,o.type.match("image.*"));else{p.append("image",o.files[0]);var t=new XMLHttpRequest;t.upload.onprogress=function(e){e.loaded/e.total*100},t.onload=function(){200==t.status?e.post.id_card_pic_front=t.responseText:alert("Error! Upload failed")},t.onerror=function(){alert("Error! Upload failed. Can not connect to server.")},t.open("POST","/idcard"),t.send(p)}},e.idcarduploadback=function(o){if(p=new FormData,o.type.match("image.*"));else{p.append("image",o.files[0]);var t=new XMLHttpRequest;t.upload.onprogress=function(e){e.loaded/e.total*100},t.onload=function(){200==t.status?e.post.id_card_pic_back=t.responseText:alert("Error! Upload failed")},t.onerror=function(){alert("Error! Upload failed. Can not connect to server.")},t.open("POST","/idcard"),t.send(p)}}}]).controller("AddEmployeeCtrl",["$scope","$rootScope","$log","$routeParams","$cookies","$http","$location","$anchorScroll","CustomerApi","Room",function(e,o,t,r,i,n,a,c,l){function s(e){var o;o=e.split(",")[0].indexOf("base64")>=0?atob(e.split(",")[1]):unescape(e.split(",")[1]);for(var t=e.split(",")[0].split(":")[1].split(";")[0],r=new Uint8Array(o.length),i=0;i<o.length;i++)r[i]=o.charCodeAt(i);return new Blob([r],{type:t})}angular.element(document).ready(function(){o.checkpermission()}),e.post={},e.getcontent=function(){e.array_person=e.person_area.split("!"),e.post.id_card=parseInt(e.array_person[0]),e.post.birth_date=new Date(e.array_person[1].split("/")[2]-543,e.array_person[1].split("/")[1]-1,e.array_person[1].split("/")[0]),e.post.prefix=e.array_person[3],e.post.name=e.array_person[4],e.post.last_name=e.array_person[5],e.post.id_card_create=new Date(e.array_person[6].split("/")[2]-543,e.array_person[6].split("/")[1]-1,e.array_person[6].split("/")[0]),e.post.id_card_expiry=new Date(e.array_person[7].split("/")[2]-543,e.array_person[7].split("/")[1]-1,e.array_person[7].split("/")[0]),e.post.address_no=e.array_person[8],e.post.address_moo=" "===e.array_person[9]?"-":e.array_person[9],e.post.address_road=e.array_person[11],e.post.address_tumbol=e.array_person[12],e.post.address_aumphur=e.array_person[13],e.post.address_province=e.array_person[14],t.log(e.array_person)},e.callcamera=function(){if(!o.isMobile){var t=document.getElementById("canvas"),r=t.getContext("2d"),i=document.getElementById("video"),n={video:!0},a=function(){};navigator.getUserMedia?navigator.getUserMedia(n,function(e){i.src=e,i.play()},a):navigator.webkitGetUserMedia?navigator.webkitGetUserMedia(n,function(e){i.src=window.webkitURL.createObjectURL(e),i.play()},a):navigator.mozGetUserMedia&&navigator.mozGetUserMedia(n,function(e){i.src=window.URL.createObjectURL(e),i.play()},a),document.getElementById("snap").addEventListener("click",function(){r.drawImage(i,0,0,640,480);var o=t.toDataURL("image/png"),n=s(o),a=new FormData;a.append("image",n);var c=new XMLHttpRequest;c.upload.onprogress=function(e){e.loaded/e.total*100},c.onload=function(){200==c.status?e.post.id_card_pic_front=c.responseText:alert("Error! Upload failed")},c.onerror=function(){alert("Error! Upload failed. Can not connect to server.")},c.open("POST","/idcard"),c.send(a)})}},e.insert=function(){e.post.parent=i.UID,l.post(e.post,function(e){t.warn(e),a.path("manage_customer"),a.replace()})};var p=new FormData;e.idcarduploadfront=function(o){if(p=new FormData,o.type.match("image.*"));else{p.append("image",o.files[0]);var t=new XMLHttpRequest;t.upload.onprogress=function(e){e.loaded/e.total*100},t.onload=function(){200==t.status?e.post.id_card_pic_front=t.responseText:alert("Error! Upload failed")},t.onerror=function(){alert("Error! Upload failed. Can not connect to server.")},t.open("POST","/idcard"),t.send(p)}},e.idcarduploadback=function(o){if(p=new FormData,o.type.match("image.*"));else{p.append("image",o.files[0]);var t=new XMLHttpRequest;t.upload.onprogress=function(e){e.loaded/e.total*100},t.onload=function(){200==t.status?e.post.id_card_pic_back=t.responseText:alert("Error! Upload failed")},t.onerror=function(){alert("Error! Upload failed. Can not connect to server.")},t.open("POST","/idcard"),t.send(p)}}}]).controller("EditPersonCtrl",["$scope","$rootScope","$log","$routeParams","$cookies","$location","$anchorScroll","CustomerApi","Room",function(e,o,t,r,i,n,a,c){angular.element(document).ready(function(){o.checkpermission()}),c.get({_id:r.person_id},function(o){e.post=o,e.post.birth_date=new Date(o.birth_date),e.post.id_card_create=new Date(o.id_card_create),e.post.id_card_expiry=new Date(o.id_card_expiry)}),e.update=function(){c.post(e.post,function(e){t.warn(e),n.path("manage_customer"),n.replace()})}}]).controller("PrintReportNoVatCtrl",["$scope","$rootScope","$log","$routeParams","$cookies","$location","$anchorScroll","Building","Room","TransactionApi","InvoiceApi",function(e,o,t,r,i,n,a,c,l,s,p){angular.element(document).ready(function(){o.checkpermission(),e.inv=[],void 0!==r.property_id?s.query({property_id:r.property_id},function(o){o.$resolved&&(e.report_list=o)}):r.transaction_id&&s.get({transaction_id:r.transaction_id},function(o){o.$resolved&&(e.$watch("report_list",function(e,o){console.log(e),console.log(o)}),e.report_list=[o]),t.log(o)}),e.$watch("report_list",function(o){if(o){e._invoice=function(o){console.log(o);for(var t=0;t<e.report_list.length;t++)for(var r=0;r<o.length;r++)e.report_list[t]._id===o[r].transaction_ref&&(e.report_list[t]._inv=o[r],e.report_list[t]._invorder=o[r].running)};for(var t=0;t<e.report_list.length;t++)e.inv.push(e.report_list[t]._id);p.post_query({invoice:e.inv},e._invoice)}})})}]).controller("PrintReportCompleteBillCtrl",["$scope","$rootScope","$log","$routeParams","$cookies","$location","$anchorScroll","Building","Room","TransactionApi","ServerTime",function(e,o,t,r,i,n,a,c,l,s,p){angular.element(document).ready(function(){o.checkpermission()}),l.query({complete_payment:r.apartment_id},function(o){o.$resolved&&(console.log(o),e.report_list=o)}),p.get("",function(o){console.log(o),e.server_time=o.time})}]).controller("PrintReportUnCompleteBillCtrl",["$scope","$rootScope","$log","$routeParams","$cookies","$location","$anchorScroll","Building","Room","InvoiceApi","ServerTime",function(e,o,t,r,i,n,a,c,l,s,p){angular.element(document).ready(function(){o.checkpermission()}),e.inv=[],e.$watch("report_list",function(o){if(o){e._invoice=function(o){for(var t=0;t<e.report_list.length;t++)for(var r=0;r<o.length;r++)e.report_list[t]._id===o[r].transaction_ref&&(e.report_list[t]._inv=o[r],e.report_list[t]._invorder=o[r].running,e.report_list[t].water_total=(e.report_list[t].water_meter[0].water_meter-e.report_list[t].water_meter[1].water_meter)*e.report_list[t].room_ref.room_water_extra,e.report_list[t].elect_total=(e.report_list[t].elect_meter[0].elect_meter-e.report_list[t].elect_meter[1].elect_meter)*e.report_list[t].room_ref.room_energy_extra,e.report_list[t].total_sum=parseFloat(e.report_list[t].water_total)+parseFloat(e.report_list[t].elect_total)+parseFloat(e.report_list[t].room_ref.room_rate)+parseFloat(e.report_list[t].room_ref.room_furniture),e.report_list[t].name=e.report_list[t].customer_ref.name);console.log(e.report_list)};for(var t=0;t<e.report_list.length;t++)e.inv.push(e.report_list[t]._id);s.post_query({invoice:e.inv},e._invoice)}}),l.query({remain:r.apartment_id},function(o){o.$resolved&&(console.log(o),e.report_list=o)}),p.get("",function(o){console.log(o),e.server_time=o.time})}]).controller("PrintReportVatCtrl",["$scope","$rootScope","$log","$routeParams","$cookies","$location","$anchorScroll","Building","Room","TransactionApi","InvoiceApi","ServerTime",function(e,o,t,r,i,n,a,c,l,s,p,d){angular.element(document).ready(function(){o.checkpermission(),e.inv=[],void 0!==r.property_id?s.query({property_id:r.property_id},function(o){o.$resolved&&(e.report_list=o)}):r.transaction_id&&s.get({transaction_id:r.transaction_id},function(o){o.$resolved&&(e.$watch("report_list",function(e,o){console.log(e),console.log(o)}),e.report_list=[o]),t.log(o)}),e.$watch("report_list",function(o){if(o){e._invoice=function(o){console.log(o);for(var t=0;t<e.report_list.length;t++)for(var r=0;r<o.length;r++)e.report_list[t]._id===o[r].transaction_ref&&(e.report_list[t]._inv=o[r],e.report_list[t]._invorder=o[r].running)};for(var t=0;t<e.report_list.length;t++)e.inv.push(e.report_list[t]._id);p.post_query({invoice:e.inv},e._invoice)}})}),d.get("",function(o){console.log(o),e.server_time=o.time,console.log(e.server_time)})}]).controller("PrintReportCustomVatCtrl",["$scope","$rootScope","$log","$routeParams","$cookies","$location","$anchorScroll","Building","Room","TransactionApi",function(e,o){e.item_list=[],angular.element(document).ready(function(){o.checkpermission()}),e.items=[{name:"ค่ามัดจำ",price:500},{name:"ค่าประกัน",price:1e4},{name:"คาคีย์การ์ด",price:100},{name:"อินเตอร์เน็ต",price:300},{name:'ทีวี 21"',price:100}]}]).controller("PrintReportCtrl",["$scope","$rootScope","$log","$routeParams","$cookies","$location","$anchorScroll","Building","Room","TransactionApi","InvoiceApi",function(e,o,t,r,i,n,a,c,l,s,p){angular.element(document).ready(function(){o.checkpermission(),e.inv=[],void 0!==r.property_id?s.query({property_id:r.property_id},function(o){o.$resolved&&(e.billing_list=o)}):r.transaction_id?s.get({transaction_id:r.transaction_id},function(o){o.$resolved&&(e.$watch("billing_list",function(e,o){console.log(e),console.log(o)}),e.billing_list=[o],setTimeout(function(){var o=e.billing_list[0]._id;o=o.toUpperCase(),e.codetoupper=o,e.barid="#bar_key0",$(e.barid).barcode(e.codetoupper,"code39")},200)),t.log(o)}):r.tel?s.get({tel:r.tel},function(o){o.$resolved&&(e.$watch("billing_list",function(e,o){console.log(e),console.log(o)}),e.billing_list=[o],setTimeout(function(){if(e.billing_list&&e.billing_list[0]._id){var o=e.billing_list[0]._id;o=o.toUpperCase(),e.codetoupper=o,e.barid="#bar_key0",$(e.barid).barcode(e.codetoupper,"code39")}},200)),t.log(o)}):r.room&&s.get({room_no:r.transaction_id},function(o){o.$resolved&&(e.$watch("billing_list",function(e,o){console.log(e),console.log(o)}),e.billing_list=[o],setTimeout(function(){var o=e.billing_list[0]._id;o=o.toUpperCase(),e.codetoupper=o,e.barid="#bar_key0",$(e.barid).barcode(e.codetoupper,"code39")},200)),t.log(o)}),e.$watch("billing_list",function(o){if(o){setTimeout(function(){for(var o=0;o<e.billing_list.length;o++)if(e.billing_list&&e.billing_list[0]._id){var t=e.billing_list[o]._id;t=t.toUpperCase(),e.codetoupper=t,e.barid="#bar_key"+e.billing_list[o].room_no,$(e.barid).barcode(e.codetoupper,"code39")}},500),e._invoice=function(o){console.log(o);for(var t=0;t<e.billing_list.length;t++)for(var r=0;r<o.length;r++)e.billing_list[t]._id===o[r].transaction_ref&&(e.billing_list[t]._inv=o[r],e.billing_list[t]._invorder=o[r].running)};for(var t=0;t<e.billing_list.length;t++)e.inv.push(e.billing_list[t]._id);p.post_query({invoice:e.inv},e._invoice)}})})}]).controller("PrintReportCustomCtrl",["$scope","$rootScope","$log","$routeParams","$cookies","$location","$anchorScroll","Building","Room","TransactionApi",function(e,o){e.item_list=[],angular.element(document).ready(function(){o.checkpermission()}),e.items=[{name:"ค่ามัดจำ",price:500},{name:"ค่าประกัน",price:1e4},{name:"คาคีย์การ์ด",price:100},{name:"อินเตอร์เน็ต",price:300},{name:'ทีวี 21"',price:100}]}]).controller("PrintReportBookingCtrl",["$scope","$filter","$rootScope","$log","$routeParams","$cookies","$location","$anchorScroll","Building","Room","TransactionApi",function(e,o,t,r,i,n,a,c,l,s,p){angular.element(document).ready(function(){t.checkpermission()}),p.get({transaction_id:i.transaction_id},function(i){e.buildingid=i.building_ref._id,t.transaction=i,t.customer=i.customer_ref,t.building=i.building_ref,t.room=i.room_ref,t.property=i.property_ref,e.post=i,e.pricetostring=o("thbToString")(e.post.reserve_price.toString());var n=i.customer_ref._id;n=n.toUpperCase(),e.codetoupper=n,$("#bar_key").barcode(e.codetoupper,"code39");var n=i._id;n=n.toUpperCase(),e.codetoupper=n,$("#bar_key2").barcode(e.codetoupper,"code39"),r.log(i)})}]).controller("PrintFurnitureListCtrl",["$scope","$filter","$rootScope","$log","$routeParams","$cookies","$location","$anchorScroll","Adsservice",function(e,o,t,r,i,n,a,c,l){angular.element(document).ready(function(){t.checkpermission()}),l.get({_id:i.apartment_id},function(o){o.$resolved&&(e.property=o)})}]).controller("MakeAgreeMentCtrl",["$scope","$filter","$rootScope","$log","$routeParams","$cookies","$location","$anchorScroll","Building","Room","TransactionApi","SendNotification",function(e,o,t,r,i,n,a,c,l,s,p){e.post=[],e.post.date=new Date,angular.element(document).ready(function(){t.checkpermission()}),e.insert=function(){e.post_body={},e.post_body._id=t.transaction._id,e.post_body.coverage=t.transaction.coverage,e.post_body.date_death_line=t.transaction.date_death_line,e.post_body.move_in_date=t.transaction.move_in_date,e.post_body.moveout_date=t.transaction.moveout_date,e.post_body.transaction_step=3},p.get({transaction_id:i.transaction_id},function(i){t.transaction=i,t.accompany=i.accompany,t.customer=i.customer_ref,t.customer.birth_date=t.customer.birth_date?new Date(t.customer.birth_date):"",t.customer.id_card_create=t.customer.id_card_create?new Date(t.customer.id_card_create):"",t.customer.id_card_expiry=t.customer.id_card_expiry?new Date(t.customer.id_card_expiry):"",t.transaction.move_in_date=t.transaction.move_in_date?new Date(t.transaction.move_in_date):"",t.building=i.building_ref,t.transaction.moveout_date=new Date(t.transaction.move_in_date),t.transaction.moveout_date.setYear(t.transaction.moveout_date.getFullYear()+1),t.transaction.moveout_date=new Date(t.transaction.moveout_date),t.room=i.room_ref,t.property=i.property_ref,e.buildingid=i.building_ref._id,e.post=i,t.transaction.coverage=parseInt(t.property.deposit),e.pricetostring=o("thbToString")(e.post.reserve_price.toString());var n=i._id;n=n.toUpperCase(),e.codetoupper=n,$("#bar_key").barcode(e.codetoupper,"code39"),r.log(i)})}]).controller("MakeAgreeMentReceiptCtrl",["$scope","$filter","$rootScope","$log","$routeParams","$cookies","$location","$anchorScroll","Building","Room","TransactionApi","SendNotification","CalendarApi",function(e,o,t,r,i,n,a,c,l,s,p,d,u){e.post=[],e.payment_list=[],e.item=[{name:"ค่ามัดจำ",price:500},{name:"ค่าประกัน",price:1e4},{name:"คาคีย์การ์ด",price:100},{name:"อินเตอร์เน็ต",price:300},{name:'ทีวี 21"',price:100}],e.post.payment_this=[],e.post.date=new Date,angular.element(document).ready(function(){t.checkpermission()}),e.$watch("payment_list",function(o){try{console.log(o),e.sum=0,console.log("..........");for(var t=0;t<o.length;t++)e.sum+=o[t].payment_this.price*o[t].amount;console.log(e.sum)}catch(r){}},!0),e.smsconfirm=0,e.insert=function(){e.post_body={},e.post_body.agreement_payment_status=e.transaction.agreement_payment_status,e.post_body._id=e.transaction._id,e.post_body.payment_list=e.payment_list,p.post(e.post_body,function(o){o&&(e.smsbody={},e.smsbody.email=t.property.contact_email,e.smsbody.tel=t.property.contact_mobile,e.smsbody.message="ได้รับเงินจาก "+t.customer.name+" "+t.customer.last_name+" จำนวน : "+e.sum+" บาท",console.log(e.smsbody),0==e.smsconfirm&&(e.smsconfirm++,d.post(e.smsbody,function(e){console.log(e)})),e.calendar_object={title:"ได้รับเงินจาก "+t.customer.name,textColor:"black",backgroundColor:"#a7ed57",start:Date.now(),user_ref:n.UID},u.post(e.calendar_object,function(){}),p.post(e.post_body,function(e){e&&(console.log(e),a.path("print_agreement").search("transaction_id="+e._id),a.replace())}),s.post({confirm:o.room_ref._id,room_status:2},function(e){r.log(e)}),a.path("print_agreement_receipt").search("transaction_id="+o._id))})},void 0!==i.room_id?(console.log(i.room_id+" **************"),p.get({room_ref:i.room_id},function(i){t.transaction=i,t.accompany=i.accompany,t.customer=i.customer_ref,t.customer.id_card_create=t.customer.id_card_create?new Date(t.customer.id_card_create):"",t.customer.id_card_expiry=t.customer.id_card_expiry?new Date(t.customer.id_card_expiry):"",t.transaction.move_in_date=t.transaction.move_in_date?new Date(t.transaction.move_in_date):"",t.building=i.building_ref,t.transaction.moveout_date=new Date(t.transaction.moveout_date),t.transaction.move_in_date=new Date(t.transaction.move_in_date),t.room=i.room_ref,t.property=i.property_ref,e.buildingid=i.building_ref._id,e.buildingid=i.building_ref._id,e.post=i,e.transaction.agreement_payment_status=50,e.pricetostring=o("thbToString")(e.post.reserve_price.toString()),e.payment_list=i.payment_list?i.payment_list:e.payment_list,e.roomrate={payment_this:{name:"ค่าห้อง",price:i.room_ref.room_rate},amount:"1"},e.item.push({name:"ค่าห้อง",price:i.room_ref.room_rate}),e.payment_list.unshift(e.roomrate);
var n=i._id;n=n.toUpperCase(),e.codetoupper=n,$("#bar_key").barcode(e.codetoupper,"code39"),r.log(i)})):i.transaction_id&&p.get({transaction_id:i.transaction_id},function(i){t.transaction=i,t.accompany=i.accompany,t.customer=i.customer_ref,t.customer.id_card_create=t.customer.id_card_create?new Date(t.customer.id_card_create):"",t.customer.id_card_expiry=t.customer.id_card_expiry?new Date(t.customer.id_card_expiry):"",t.transaction.move_in_date=t.transaction.move_in_date?new Date(t.transaction.move_in_date):"",t.building=i.building_ref,t.transaction.moveout_date=new Date(t.transaction.moveout_date),t.transaction.move_in_date=new Date(t.transaction.move_in_date),t.room=i.room_ref,t.property=i.property_ref,e.buildingid=i.building_ref._id,e.buildingid=i.building_ref._id,e.post=i,e.pricetostring=o("thbToString")(e.post.reserve_price.toString()),e.payment_list=i.payment_list?i.payment_list:e.payment_list,e.roomrate={payment_this:{name:"ค่าห้อง",price:i.room_ref.room_rate},amount:"1"},e.item.push({name:"ค่าห้อง",price:i.room_ref.room_rate}),e.payment_list.unshift(e.roomrate);var n=i._id;n=n.toUpperCase(),e.codetoupper=n,$("#bar_key").barcode(e.codetoupper,"code39"),r.log(i)})}]).controller("PrintAgreeMentCtrl",["$scope","$filter","$rootScope","$log","$routeParams","$cookies","$location","$anchorScroll","Building","Room","TransactionApi",function(e,o,t,r,i,n,a,c,l,s,p){e.post=[],e.post.date=new Date,angular.element(document).ready(function(){t.checkpermission()}),p.get({transaction_id:i.transaction_id},function(o){t.transaction=o,t.accompany=o.accompany,t.customer=o.customer_ref,t.customer.id_card_create=t.customer.id_card_create?new Date(t.customer.id_card_create):"",t.customer.id_card_expiry=t.customer.id_card_expiry?new Date(t.customer.id_card_expiry):"",t.transaction.move_in_date=t.transaction.move_in_date?new Date(t.transaction.move_in_date):"",t.building=o.building_ref,t.transaction.moveout_date=new Date(t.transaction.moveout_date),t.transaction.move_in_date=new Date(t.transaction.move_in_date),t.room=o.room_ref,t.property=o.property_ref,e.buildingid=o.building_ref._id,t.customer.birth_date=new Date(t.customer.birth_date),e.post=o;var i=o._id;i=i.toUpperCase(),e.codetoupper=i,$("#bar_key").barcode(e.codetoupper,"code39"),r.log(o)})}]).controller("PrintAgreeMentReceiptCtrl",["$scope","$filter","$rootScope","$log","$routeParams","$cookies","$location","$anchorScroll","Building","Room","TransactionApi",function(e,o,t,r,i,n,a,c,l,s,p){e.post=[],e.post.date=new Date,angular.element(document).ready(function(){t.checkpermission(),e.$watch("payment_list",function(o){try{console.log(o),e.sum=0,console.log("..........");for(var t=0;t<o.length;t++)e.sum+=o[t].payment_this.price*o[t].amount;console.log(e.sum)}catch(r){}},!0)}),p.get({transaction_id:i.transaction_id},function(o){t.transaction=o,t.accompany=o.accompany,t.customer=o.customer_ref,t.customer.id_card_create=t.customer.id_card_create?new Date(t.customer.id_card_create):"",t.customer.id_card_expiry=t.customer.id_card_expiry?new Date(t.customer.id_card_expiry):"",t.transaction.move_in_date=t.transaction.move_in_date?new Date(t.transaction.move_in_date):"",t.building=o.building_ref,t.transaction.moveout_date=new Date(t.transaction.moveout_date),t.transaction.move_in_date=new Date(t.transaction.move_in_date),t.room=o.room_ref,t.property=o.property_ref,e.buildingid=o.building_ref._id,e.payment_list=o.payment_list;var i=o._id;i=i.toUpperCase(),e.codetoupper=i,$("#bar_key").barcode(e.codetoupper,"code39"),r.log(o)})}]).controller("PrintReceiptBookingCtrl",["$scope","$rootScope","$log","$routeParams","$cookies","$location","$anchorScroll","Building","Room","TransactionApi",function(e,o,t,r,i,n,a,c,l,s){angular.element(document).ready(function(){o.checkpermission()}),s.get({receipt:r.transaction_id},function(r){t.log("result"),t.log(r),t.log(r.receipt__id),o.customer=r.customer_ref,o.building=r.building_ref,o.room=r.room_ref,o.property=r.property_ref;var i=r.customer_ref._id;i=i.toUpperCase(),e.codetoupper=i,$("#bar_key").barcode(e.codetoupper,"code39");var i=r._id;i=i.toUpperCase(),e.codetoupper=i,$("#bar_key2").barcode(e.codetoupper,"code39"),e.transaction=r,e.transaction.date=new Date(e.transaction.date),e.buildingid=r.building_ref._id,t.log("transaction"),t.log(e.transaction)})}]).controller("ConfirmReceiptBookingCtrl",["$scope","$rootScope","$log","$routeParams","$cookies","$location","$anchorScroll","Building","Room","TransactionApi","SendNotification",function(e,o,t,r,i,n,a,c,l,s){angular.element(document).ready(function(){o.checkpermission();var t="example1234";t=t.toUpperCase(),e.codetoupper=t,$("#bar_key").barcode(e.codetoupper,"code39"),$("#bar_key2").barcode(e.codetoupper,"code39")}),e.test=e.payment_status,void 0!==r.transaction_id?s.get({transaction_id:r.transaction_id},function(r){o.transaction=r,o.transaction=r,o.customer=r.customer_ref,o.building=r.building_ref,o.room=r.room_ref,o.property=r.property_ref,e.buildingid=r.building_ref._id,t.log(r)}):(n.path("index"),n.replace()),e.$watch("transaction.reserve_payment_status",function(o,r){t.log(o),t.log("-------------------"),t.log(r),e.reserve_payment_status=o}),e.savereceipt=function(){t.log("pms"),t.log(o.transaction),e.post_body=o.transaction,delete e.post_body.accompany,e.post_body.property_ref=e.post_body.property_ref._id,e.post_body.customer_ref=e.post_body.customer_ref._id,e.post_body.building_ref=e.post_body.building_ref._id,e.post_body.room_ref=e.post_body.room_ref._id,e.post_body.reserve_payment_status=e.reserve_payment_status,s.post(e.post_body,function(e){e&&(o.transaction=e,o.customer=e.customer_ref,o.building=e.building_ref,o.room=e.room_ref,o.property=e.property_ref,console.log(e),l.post({confirm:e.room_ref._id,room_status:1},function(e){t.log(e)}),n.path("print_receipt_booking").search("transaction_id="+e._id),n.replace()),t.log(e)})}}]).controller("PropertyCtrl",["$scope","$rootScope","$log","$routeParams","$cookies","$location","$anchorScroll","Building","Adsservice","PropertyApi",function(e,o,t,r,i,n,a,c,l,s){angular.element(document).ready(function(){o.checkpermission()}),e.property_list=[],l.query({user_id:i.UID},function(o){e.property_list=o}),e.remove_property=function(o){var r=confirm("คุณต้องการลบ "+name+" ออกจากระบบ");1==r&&s.remove({_id:o},function(o){t.warn(o),l.query({user_id:i.UID},function(o){e.property_list=o})})}}]).controller("BuildingCtrl",["$scope","$rootScope","$log","$routeParams","$cookies","$location","$anchorScroll","Building","Adsservice",function(e,o,t,r,i,n,a,c,l){angular.element(document).ready(function(){o.checkpermission()}),e.building={},l.query({user_id:i.UID},function(o){e.property_list=o}),e.addbuilding=function(){e.building.property_ref=e.property._id,e.building.user_ref=i.UID,e.building.user_ref?c.post({building:e.building},function(e){t.warn(e),c.query({user_ref:i.UID},function(e){o.building_list=e,o.initwaiting=1,n.path("manage_building"),n.replace()})}):alert("กรุณา login หรือ หรือเปิดใช้งาน Cookies หากขัดข้องกรุณาติดต่อเจ้าหน้าที่")}}]).controller("ManageCustomerCtrl",["$scope","$rootScope","$cookies","$routeParams","$location","$anchorScroll","$log","CustomerApi",function(e,o,t,r,i,n,a,c){angular.element(document).ready(function(){o.checkpermission()}),c.query({parent:t.UID},function(o){e.customerlist=o,a.warn(e.customer_list)}),e.del=function(o,r){var i=confirm("คุณต้องการลบ "+r+" ออกจากระบบ");1==i&&c.remove({_id:o},function(o){a.warn(o),c.query({parent:t.UID},function(o){e.customerlist=o,a.warn(e.customer_list)})})}}]).controller("RoomCtrl",["$scope","$rootScope","$routeParams","$log","$location","$anchorScroll","Room","PropertyApi","ElectApi","WaterApi",function(e,o,t,r,i,n,a,c){angular.element(document).ready(function(){o.checkpermission()}),e.room={},e._id=t.building_id;for(var l=o.building_list.length-1;l>=0;l--)o.building_list[l]._id===e._id&&c.get({_id:o.building_list[l].property_ref._id},function(o){e.room.property_ref=o._id,e.room.room_rate_daily=o.dailyprice,e.room.room_rate=o.price_min,r.log(o)});r.log(o.building_list),e.addroom=function(){e.room.building_ref=t.building_id,r.log(e.room),a.post({room:e.room},function(e){r.warn(e),i.path("/manage_room").search("building_id="+t.building_id),i.replace()})}}]).controller("ManageSiteCtrl",["$scope","$rootScope","$log","$routeParams","$cookies","$location","$anchorScroll","Building","Adsservice","PropertyApi",function(e,o,t,r,i,n,a,c,l,s){angular.element(document).ready(function(){o.checkpermission()}),l.query({user_id:i.UID},function(o){e.property_list=o}),e.remove_building=function(o){var r=confirm("คุณต้องการลบ "+name+" ออกจากระบบ");1==r&&s.remove({_id:o},function(o){t.warn(o),l.query({user_id:i.UID},function(o){e.property_list=o})})}}]).controller("ManagebuildingCtrl",["$scope","$routeParams","$rootScope","$log","$cookies","$location","$anchorScroll","Building",function(e,o,t,r,i,n,a,c){angular.element(document).ready(function(){t.checkpermission()}),e.room={},e.remove_building=function(e,o){var n=confirm("คุณต้องการลบตึก "+o);1==n&&c.remove({building_id:e},function(e){r.warn(e),alert("ตึก "+e.building+" ถูกลบเรียบร้อยแล้ว"),c.query({user_ref:i.UID},function(e){t.building_list=e,t.initwaiting=1})})}}]).controller("ManageRoomCtrl",["$scope","$routeParams","$rootScope","$log","$location","Room","Building","$anchorScroll",function(e,o,t,r,i,n,a){angular.element(document).ready(function(){t.checkpermission()}),a.get({building_id:o.building_id},function(o){e.building_detail=o}),o.building_id&&(e.buildingid=o.building_id,e.waiting=0,n.query({building_ref:o.building_id},function(o){e.room_list=o,e.waiting=1})),e.select_building=function(e){i.path("manage_room").search("building_id="+e),i.replace()},e.remove_room=function(t,r){var i=confirm("คุณต้องการลบห้อง "+r);1==i&&n.remove({room_id:t},function(){n.query({building_ref:o.building_id},function(o){e.room_list=o,e.waiting=1})})}}]).controller("loginCtrl",["$scope","$rootScope","$routeParams","$location","$anchorScroll","$log","$cookies","Check","Building",function(e,o,t,r,i,n,a,c,l){angular.element(document).ready(function(){o.checkpermission()}),a.UID&&(r.path("/index"),r.replace()),e.login=function(){c.query({username:e.login.username,password:e.login.pass},function(t){n.warn(t),void 0!==t.permission?(a.Tel=t.tel,a.Name=t.name,a.UID=t._id,a.Hash=t.password,a.Permission=t.permission,a.Email=t.email,a.Favoriteap=t.favoriteap,o.permissionGlobal=a.Permission,o.username=a.Name,o.idme=a.UID,e.displayCheckBox=!1,l.query({user_ref:a.UID},function(e){o.building_list=e,o.initwaiting=1,n.log(o.building_list)}),r.path("/manager#!?/index"),r.replace()):alert("Please Check your username and password")})}}]);